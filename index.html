<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>VVF Smart - Terminale Operativo</title>
    
    <!-- FONT EXO 2 (GOOGLE FONTS) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Exo+2:ital,wght@0,300;0,400;0,500;0,600;0,700;0,800;1,400&display=swap" rel="stylesheet">

    <style>
        /* --- CONFIGURAZIONE COLORI & FONT (PALETTE UFFICIALE + TECH) --- */
        :root {
            /* Palette VVF */
            --vvf-verde: #4d8b55;         /* Verde tecnico (dalla palette) */
            --vvf-oro: #c5a065;           /* Oro tecnico (dalla palette) */
            --vvf-crema: #f2efe4;         /* Crema sfondo (dalla palette) */
            --vvf-rosso: #ce3824;         /* Rosso VVF */
            --vvf-grigio: #9e9e9e;        /* Grigio neutro */
            
            /* Varianti Tech */
            --tech-dark: #1a1a2e;
            --tech-border: #bac9d0;
            --tech-grid: rgba(0, 0, 0, 0.05);
            --tech-overlay: rgba(255, 255, 255, 0.92); /* Sfondo schede semitrasparente */
        }

        body { 
            font-family: 'Exo 2', sans-serif;
            background-color: var(--vvf-crema); 
            margin: 0; 
            padding: 20px 15px; 
            color: var(--tech-dark);
            -webkit-font-smoothing: antialiased;
            overflow-x: hidden;
            /* Pattern Griglia Millimetrata di Sfondo */
            background-image: 
                linear-gradient(var(--tech-grid) 1px, transparent 1px),
                linear-gradient(90deg, var(--tech-grid) 1px, transparent 1px);
            background-size: 20px 20px;
        }

        /* --- BACKGROUND ANIMATO (DISEGNI TECNICI) --- */
        .tech-background-container {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: -1;
            pointer-events: none;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .tech-bg-drawing {
            position: absolute;
            width: 80%;
            max-width: 500px;
            opacity: 0;
            fill: none;
            stroke: rgba(0, 0, 0, 0.08); /* Disegno molto leggero */
            stroke-width: 1.5;
            animation: cycleDrawings 20s infinite;
        }

        /* Ritardi per l'alternanza dei disegni */
        .tech-bg-drawing:nth-child(1) { animation-delay: 0s; }
        .tech-bg-drawing:nth-child(2) { animation-delay: 5s; }
        .tech-bg-drawing:nth-child(3) { animation-delay: 10s; }
        .tech-bg-drawing:nth-child(4) { animation-delay: 15s; }

        @keyframes cycleDrawings {
            0% { opacity: 0; transform: scale(0.95); }
            5% { opacity: 1; transform: scale(1); }
            20% { opacity: 1; transform: scale(1); }
            25% { opacity: 0; transform: scale(1.05); }
            100% { opacity: 0; }
        }
        
        /* --- LAYOUT "SCHEDA TECNICA" --- */
        .card { 
            background: var(--tech-overlay); 
            padding: 25px 20px; 
            margin-bottom: 25px; 
            position: relative;
            /* Bordo tecnico invece che arrotondato semplice */
            border: 1px solid var(--tech-border);
            border-left: 4px solid var(--vvf-rosso); /* Accento laterale */
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            clip-path: polygon(
                0 0, 
                100% 0, 
                100% calc(100% - 15px), 
                calc(100% - 15px) 100%, 
                0 100%
            ); /* Angolo tagliato stile tech in basso a destra */
        }

        /* Marker decorativi agli angoli (Stile Blueprint) */
        .card::before {
            content: '';
            position: absolute;
            top: 0; right: 0;
            width: 15px; height: 15px;
            border-top: 2px solid var(--vvf-oro);
            border-right: 2px solid var(--vvf-oro);
        }

        .header { text-align: center; margin-bottom: 30px; position: relative; z-index: 2; }
        
        /* LOGO STYLE */
        .logo-container {
            width: 140px;
            height: 90px;
            margin: 0 auto 15px auto;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .logo-svg { width: 100%; height: 100%; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1)); }

        .header h1 { 
            color: var(--vvf-rosso); 
            margin: 0; 
            font-size: 24px; 
            font-weight: 800; 
            text-transform: uppercase; 
            letter-spacing: 2px; 
            border-bottom: 2px solid var(--vvf-oro);
            display: inline-block;
            padding-bottom: 5px;
        }
        .header p { 
            color: var(--vvf-grigio); 
            font-size: 11px; 
            margin-top: 8px; 
            font-weight: 600; 
            text-transform: uppercase; 
            letter-spacing: 3px; 
        }

        /* INPUT STYLE - Minimal Tech */
        label { 
            font-weight: 700; font-size: 11px; 
            display: block; margin-top: 20px; margin-bottom: 5px;
            color: var(--tech-dark); 
            text-transform: uppercase; letter-spacing: 1px; 
            border-left: 3px solid var(--vvf-oro);
            padding-left: 8px;
        }
        
        input, select, textarea { 
            width: 100%; 
            padding: 12px; 
            border: 1px solid var(--tech-border); 
            background: rgba(255,255,255,0.8);
            font-size: 15px; 
            font-family: 'Exo 2', sans-serif;
            color: var(--tech-dark);
            box-sizing: border-box;
            transition: all 0.3s;
            border-radius: 0; /* Angoli vivi per stile tecnico */
        }
        input:focus, select:focus, textarea:focus { 
            outline: none; 
            border-color: var(--vvf-rosso); 
            background: #fff;
            box-shadow: inset 3px 0 0 var(--vvf-rosso);
        }
        
        /* BOTTONI - Stile Industriale */
        button { 
            background-color: var(--vvf-rosso); 
            color: white; 
            border: none; 
            padding: 16px; 
            width: 100%; 
            font-size: 14px; 
            font-weight: 700; 
            cursor: pointer; 
            margin-top: 25px; 
            text-transform: uppercase;
            letter-spacing: 1px;
            position: relative;
            overflow: hidden;
            border-bottom: 3px solid rgba(0,0,0,0.2); /* Effetto 3D flat */
        }
        button:active { transform: translateY(2px); border-bottom: 1px solid rgba(0,0,0,0.2); }
        
        button.secondary { background-color: var(--vvf-oro); color: #333; }
        button.ghost { 
            background-color: transparent; 
            color: var(--vvf-grigio); 
            border: 1px dashed var(--tech-border); 
            margin-top: 15px; 
            padding: 10px;
            font-size: 12px;
        }
        
        /* UI ELEMENTI */
        .login-msg { font-size: 13px; text-align: center; margin-bottom: 20px; color: var(--tech-dark); font-style: italic; }
        .error-msg { color: var(--vvf-rosso); font-size: 12px; margin-top: 5px; font-weight: bold; display: none; text-align: right; }

        /* BADGES TURNI - Palette */
        .badge { 
            display: inline-flex; 
            align-items: center; justify-content: center;
            padding: 4px 10px; 
            color: white; font-weight: 700; font-size: 0.9em; 
            min-width: 30px; text-align: center; 
            border: 1px solid rgba(255,255,255,0.2);
        }
        .bg-A { background-color: var(--vvf-rosso); }
        .bg-B { background-color: var(--vvf-verde); } /* Uso del verde */
        .bg-C { background-color: var(--vvf-oro); color: #333; }
        .bg-D { background-color: var(--tech-dark); }

        /* RISULTATI */
        .result-box { 
            background-color: rgba(255,255,255,0.95); 
            border: 1px solid var(--vvf-verde); 
            border-left-width: 5px;
            padding: 15px; 
            margin-top: 25px; 
            display: none; 
            position: relative;
        }
        .result-box::after {
            content: 'STATUS: CALCOLATO';
            position: absolute; top: -10px; right: 10px;
            background: var(--vvf-verde); color: white;
            font-size: 10px; padding: 2px 6px;
            font-weight: bold;
        }
        
        /* STORICO */
        .history-item { 
            border-bottom: 1px dashed var(--tech-border); 
            padding: 15px 0; 
            display: flex; flex-direction: column; gap: 8px; 
        }
        .history-header { display: flex; justify-content: space-between; align-items: center; }
        .history-date { font-weight: 700; color: var(--tech-dark); font-size: 14px; text-transform: uppercase; }
        .history-sub { font-size: 12px; color: #666; font-family: monospace; }
        .history-actions { display: flex; justify-content: flex-end; gap: 10px; }
        
        .btn-delete { 
            background: none; border: none; color: var(--vvf-rosso); 
            padding: 0; margin: 0; width: auto; 
            font-size: 11px; font-weight: 700; text-transform: uppercase; cursor: pointer;
        }
        
        /* INFO TURNO BOX (HUD Style) */
        .info-turno-box {
            background: var(--tech-overlay); 
            padding: 15px; 
            margin-top: 10px; 
            display: flex; justify-content: space-between; align-items: center;
            border: 1px solid var(--tech-border);
            border-bottom: 3px solid var(--vvf-rosso);
        }

        /* TABELLA DETTAGLI */
        .detail-table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 13px; }
        .detail-table td { padding: 10px; border-bottom: 1px solid var(--tech-border); }
        .detail-label { color: #666; text-transform: uppercase; font-size: 11px; letter-spacing: 0.5px; }
        .detail-val { text-align: right; color: var(--tech-dark); font-weight: 700; font-family: monospace; font-size: 14px; }
        .detail-notes { margin-top: 20px; font-size: 13px; color: #444; background: rgba(0,0,0,0.03); padding: 15px; border-left: 3px solid var(--vvf-oro); }

        .hidden { display: none !important; }
    </style>
</head>
<body>

    <!-- SFONDO ANIMATO CON DISEGNI TECNICI -->
    <div class="tech-background-container">
        <!-- 1. APS (Auto Pompa Serbatoio) -->
        <svg class="tech-bg-drawing" viewBox="0 0 200 100">
            <path d="M20 70 L20 40 L40 20 L70 20 L70 70 M75 70 L75 20 L180 20 L180 70 M45 70 L65 70 M95 70 L160 70" stroke="currentColor" />
            <circle cx="60" cy="70" r="12" stroke="currentColor" />
            <circle cx="140" cy="70" r="12" stroke="currentColor" />
            <path d="M80 25 L175 25 M80 35 L175 35 M80 45 L175 45" stroke-dasharray="4,2" stroke="currentColor" />
        </svg>
        
        <!-- 2. Autoscala -->
        <svg class="tech-bg-drawing" viewBox="0 0 200 100">
            <path d="M20 70 L170 70 L170 50 L40 50 L20 70" stroke="currentColor" />
            <line x1="50" y1="50" x2="160" y2="10" stroke="currentColor" stroke-width="2" />
            <line x1="55" y1="52" x2="165" y2="12" stroke="currentColor" stroke-width="2" />
            <line x1="60" y1="50" x2="60" y2="25" stroke="currentColor" />
            <circle cx="50" cy="70" r="10" stroke="currentColor" />
            <circle cx="140" cy="70" r="10" stroke="currentColor" />
        </svg>

        <!-- 3. Elicottero Drago -->
        <svg class="tech-bg-drawing" viewBox="0 0 200 100">
            <ellipse cx="100" cy="60" rx="60" ry="25" stroke="currentColor" />
            <line x1="40" y1="60" x2="10" y2="60" stroke="currentColor" stroke-width="3" />
            <line x1="10" y1="50" x2="10" y2="70" stroke="currentColor" stroke-width="3" />
            <line x1="100" y1="35" x2="100" y2="10" stroke="currentColor" stroke-width="2" />
            <line x1="40" y1="10" x2="160" y2="10" stroke="currentColor" stroke-width="2" />
        </svg>

        <!-- 4. Lancia Blue Devil / Alta Pressione -->
        <svg class="tech-bg-drawing" viewBox="0 0 200 100">
            <path d="M40 60 L140 60 L160 40 L160 70 L140 50 L40 50 Z" stroke="currentColor" />
            <rect x="20" y="45" width="20" height="20" stroke="currentColor" />
            <line x1="160" y1="55" x2="190" y2="55" stroke="currentColor" stroke-dasharray="2,2" />
        </svg>
    </div>

    <!-- LOGO GLOBALE -->
    <div style="text-align: center; margin-top: 40px;">
        <div class="logo-container">
            <!-- APS VIGILI DEL FUOCO - DISEGNO TECNICO STILIZZATO -->
            <svg class="logo-svg" viewBox="0 0 120 70" xmlns="http://www.w3.org/2000/svg">
                <style>
                    .tech-line { fill: none; stroke: var(--vvf-rosso); stroke-width: 2.5; stroke-linecap: round; stroke-linejoin: round; }
                    .tech-detail { fill: none; stroke: var(--vvf-rosso); stroke-width: 1.5; }
                    .tech-accent { fill: none; stroke: var(--vvf-oro); stroke-width: 2; }
                    .tech-light { fill: var(--vvf-oro); stroke: none; }
                </style>
                <path class="tech-line" d="M15 45 L15 25 L25 15 L40 15 L40 45 Z" />
                <path class="tech-detail" d="M25 15 L25 25 L40 25" /> 
                <path class="tech-line" d="M42 45 L42 15 L105 15 L105 45" />
                <line class="tech-detail" x1="55" y1="20" x2="55" y2="40" />
                <line class="tech-detail" x1="70" y1="20" x2="70" y2="40" />
                <line class="tech-detail" x1="85" y1="20" x2="85" y2="40" />
                <rect class="tech-detail" x="45" y="18" width="55" height="24" rx="2" />
                <path class="tech-line" d="M10 45 L25 45 M55 45 L85 45 M115 45 L105 45" />
                <circle class="tech-line" cx="40" cy="45" r="8" />
                <circle class="tech-line" cx="95" cy="45" r="8" />
                <circle class="tech-detail" cx="40" cy="45" r="3" />
                <circle class="tech-detail" cx="95" cy="45" r="3" />
                <path class="tech-accent" d="M45 12 L100 8" />
                <line class="tech-accent" x1="50" y1="11" x2="50" y2="14" />
                <line class="tech-accent" x1="65" y1="10" x2="65" y2="13" />
                <line class="tech-accent" x1="80" y1="9" x2="80" y2="12" />
                <line class="tech-accent" x1="95" y1="8" x2="95" y2="11" />
                <path class="tech-light" d="M30 15 L30 10 L36 10 L36 15 Z" />
            </svg>
        </div>
    </div>

    <!-- SCHERMATA LOGIN -->
    <div id="view-login">
        <div class="header">
            <h1>INSERIMENTO ORE MISSIONE</h1>
            <p>VIGILI DEL FUOCO SIENA</p>
        </div>

        <div class="card">
            <p class="login-msg" id="login-intro">ACCESSO AL SISTEMA</p>
            
            <label>Identificativo Utente</label>
            <input type="text" id="username" placeholder="ES. MARCOROSSI" oninput="resetLoginUI()">
            
            <div id="password-section" class="hidden">
                <label>Codice Sicurezza</label>
                <input type="password" id="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
            </div>

            <div id="register-section" class="hidden">
                <p style="color: var(--vvf-oro); font-size: 12px; margin-top: 15px; border: 1px dashed var(--vvf-oro); padding: 5px;">NUOVO UTENTE RILEVATO. IMPOSTA PASSWORD.</p>
                <label>Crea Password</label>
                <input type="password" id="new-password" placeholder="SCEGLI PASSWORD">
            </div>

            <p id="error-text" class="error-msg">ERRORE CREDENZIALI</p>

            <button id="btn-login-action" onclick="checkUser()">PROCEDI</button>
        </div>
    </div>

    <!-- SCHERMATA APP -->
    <div id="view-app" class="hidden">
        <div class="header">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 5px;">
                <h1 style="font-size: 18px; border:none; padding:0;">REGISTRO OPERATIVO</h1>
                <span id="user-badge" style="background:var(--tech-dark); color:white; padding:4px 10px; font-size:10px; font-weight:bold; letter-spacing:1px;">USER</span>
            </div>
            
            <div class="info-turno-box">
                <div>
                    <!-- Data odierna live -->
                    <strong id="data-live" style="font-size: 16px; color: var(--tech-dark); text-transform: uppercase;">-- -- ----</strong>
                    <span style="font-size: 11px; color: #666; display:block; margin-top:2px; font-family:monospace;">ORA LOCALE: <span id="orario-live">--:--</span></span>
                </div>
                <div id="oggi-turno-badge">...</div>
            </div>
        </div>

        <div class="card">
            <label>Tipologia Intervento</label>
            <select id="tipo">
                <option value="Soccorso">ðŸ”¥ STRAORDINARIO SOCCORSO</option>
                <option value="Guida">ðŸš’ ORE DI GUIDA</option>
                <option value="Boschivo">ðŸŒ² AIB / BOSCHIVO</option>
            </select>

            <label>Inizio Operazioni</label>
            <input type="datetime-local" id="inizio">

            <label>Fine Operazioni</label>
            <input type="datetime-local" id="fine">

            <label>Note Operative</label>
            <textarea id="note" rows="2" placeholder="RIFERIMENTI INTERVENTO / DETTAGLI..."></textarea>

            <button onclick="calcolaESalva()">REGISTRA E CALCOLA</button>

            <div id="risultato-box" class="result-box"></div>
            <button id="btn-vedi-dettaglio" class="secondary hidden" onclick="mostraDettaglioUltimo()">ANALISI FASCE ORARIE</button>
        </div>

        <div class="card">
            <h3 style="color: var(--vvf-rosso); margin-top:0; text-transform: uppercase; font-size: 14px; letter-spacing: 1px; border-bottom: 2px solid var(--tech-grid); padding-bottom: 10px;">Archivio Storico</h3>
            <div id="lista-storico"></div>
            <button class="ghost" onclick="resetStorico()">RESET DATABASE</button>
        </div>

        <button class="ghost" onclick="logout()" style="border-style: solid; border-color: var(--tech-dark); color: var(--tech-dark);">DISCONNESSIONE</button>
    </div>

    <!-- NUOVA SCHERMATA: DETTAGLIO CALCOLI -->
    <div id="view-detail" class="hidden">
        <div class="header">
            <h1 style="font-size: 20px;">DETTAGLIO FASCE</h1>
            <p>RIPARTIZIONE ORE</p>
        </div>
        
        <div class="card">
            <div id="detail-content"></div>
            <button class="secondary" onclick="chiudiDettaglio()">CHIUDI SCHEDA</button>
        </div>
    </div>

    <script>
        // ===============================================
        //  1. CONFIGURAZIONE TURNI
        // ===============================================
        
        // Sequenza: C (08-20), B (20-08), D (08-20), C (20-08), A (08-20), D (20-08), B (08-20), A (20-08)
        const sequenzaTurni = ['C', 'B', 'D', 'C', 'A', 'D', 'B', 'A']; 
        
        // PUNTO ZERO: 1 Dicembre 2025 ore 08:00 = TURNO C (Indice 0)
        const dataAncora = new Date(2025, 11, 1, 8, 0, 0); // 11 = Dicembre

        // LISTA GIORNI SUPER FESTIVI (Giorno/Mese)
        const superFestiviFissi = [
            "1/1", "6/1", "25/4", "1/5", "2/6", "15/8", "1/11", "8/12", "25/12", "26/12"
        ];

        // Calcolo Pasqua
        function isPasquaOPasquetta(date) {
            const pasque = ["2025-04-20", "2026-04-05"]; 
            const pasquette = ["2025-04-21", "2026-04-06"];
            let iso = date.toISOString().split('T')[0];
            return pasque.includes(iso) || pasquette.includes(iso);
        }

        function getTurno(dataOggetto) {
            let diffMs = dataOggetto.getTime() - dataAncora.getTime();
            let diffOre = diffMs / (1000 * 60 * 60);
            let blocchiDa12Ore = Math.floor(diffOre / 12);
            let indice = ((blocchiDa12Ore % 8) + 8) % 8;
            return sequenzaTurni[indice];
        }

        // ===============================================
        //  2. LOGICA LOGIN
        // ===============================================
        let dbUtenti = JSON.parse(localStorage.getItem('vvf_users_db') || '{}');
        let currentUser = null;
        let loginState = 'check';

        function checkUser() {
            let userField = document.getElementById('username');
            let user = userField.value.trim();
            
            if(!user) return;

            if (loginState === 'check') {
                if (dbUtenti.hasOwnProperty(user)) {
                    document.getElementById('password-section').classList.remove('hidden');
                    document.getElementById('btn-login-action').innerText = "ACCESSO";
                    loginState = 'login';
                    userField.disabled = true;
                } else {
                    document.getElementById('register-section').classList.remove('hidden');
                    document.getElementById('btn-login-action').innerText = "REGISTRAZIONE";
                    loginState = 'register';
                    userField.disabled = true;
                }
            } else if (loginState === 'login') {
                if (dbUtenti[user] === document.getElementById('password').value) avviaApp(user);
                else { document.getElementById('error-text').style.display = 'block'; }
            } else if (loginState === 'register') {
                let newPass = document.getElementById('new-password').value;
                if (newPass) {
                    dbUtenti[user] = newPass;
                    localStorage.setItem('vvf_users_db', JSON.stringify(dbUtenti));
                    avviaApp(user);
                }
            }
        }

        function resetLoginUI() {
            document.getElementById('password-section').classList.add('hidden');
            document.getElementById('register-section').classList.add('hidden');
            document.getElementById('btn-login-action').innerText = "PROCEDI";
            document.getElementById('error-text').style.display = 'none';
            loginState = 'check';
        }

        function avviaApp(user) {
            currentUser = user;
            document.getElementById('view-login').classList.add('hidden');
            document.getElementById('view-app').classList.remove('hidden');
            document.getElementById('user-badge').innerText = user.toUpperCase();
            impostaDateDefault();
            aggiornaLiveUI();
            setInterval(aggiornaLiveUI, 60000);
            caricaStorico();
        }

        function logout() { location.reload(); }

        // ===============================================
        //  3. CORE APP & NUOVO CALCOLO DETTAGLIATO
        // ===============================================

        let ultimoCalcoloDettagli = null; 

        function aggiornaLiveUI() {
            let now = new Date();
            let turno = getTurno(now);
            
            let opzioniData = { weekday: 'short', day: 'numeric', month: 'short', year: 'numeric' };
            document.getElementById('data-live').innerText = now.toLocaleDateString('it-IT', opzioniData);
            
            let ore = String(now.getHours()).padStart(2, '0');
            let min = String(now.getMinutes()).padStart(2, '0');
            document.getElementById('orario-live').innerText = `${ore}:${min}`;

            document.getElementById('oggi-turno-badge').innerHTML = 
                `<span class="badge bg-${turno}" style="font-size:1.4em; padding:5px 15px; border:2px solid var(--vvf-rosso); color:var(--vvf-rosso); background:transparent;">${turno}</span>`;
        }

        function impostaDateDefault() {
            let now = new Date();
            now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            document.getElementById('inizio').value = now.toISOString().slice(0,16);
            document.getElementById('fine').value = now.toISOString().slice(0,16);
        }

        // Funzione helper per categorizzare un timestamp specifico
        function getCategoriaOraria(dateObj) {
            let h = dateObj.getHours();
            let d = dateObj.getDate();
            let m = dateObj.getMonth() + 1; // 1-12
            let keyDate = `${d}/${m}`;
            let dayOfWeek = dateObj.getDay(); // 0 = Domenica, 6 = Sabato

            // 1. REGOLA D'ORO: Se non siamo tra le 06:00 e le 22:00, Ã¨ Notturno
            if (h < 6 || h >= 22) {
                return 'notturno';
            }

            // SE SIAMO QUI, SIAMO CERTAMENTE TRA LE 06:00 E LE 22:00
            
            // 2. Controllo Super Festivi
            if (superFestiviFissi.includes(keyDate) || isPasquaOPasquetta(dateObj)) {
                return 'super_festivo';
            }

            // 3. Controllo Festivi (SOLO DOMENICA)
            if (dayOfWeek === 0) {
                return 'festivo';
            }

            // 4. Tutto il resto Ã¨ Feriale Diurno
            return 'feriale';
        }

        function calcolaESalva() {
            let inizio = new Date(document.getElementById('inizio').value);
            let fine = new Date(document.getElementById('fine').value);
            let tipo = document.getElementById('tipo').value;
            let note = document.getElementById('note').value;

            if (fine <= inizio) { alert("Errore: Fine precedente all'inizio."); return; }

            // A. Calcolo Segmenti Turno
            let segmenti = [];
            let cursore = new Date(inizio);
            let totaleOre = 0;

            while (cursore < fine) {
                let prossimoCambio = new Date(cursore);
                let ora = cursore.getHours();
                if (ora >= 8 && ora < 20) prossimoCambio.setHours(20, 0, 0, 0);
                else {
                    if (ora >= 20) prossimoCambio.setDate(prossimoCambio.getDate() + 1);
                    prossimoCambio.setHours(8, 0, 0, 0);
                }
                let fineSegmento = (prossimoCambio < fine) ? prossimoCambio : fine;
                let durataOre = (fineSegmento - cursore) / (1000 * 60 * 60);
                let pm = new Date(cursore.getTime() + ((fineSegmento - cursore) / 2));
                
                segmenti.push({ turno: getTurno(pm), ore: durataOre });
                totaleOre += durataOre;
                cursore = fineSegmento;
            }

            // B. CALCOLO DETTAGLIATO FASCE (Minuto per minuto)
            let dettagli = { feriale: 0, festivo: 0, super_festivo: 0, notturno: 0 };
            
            let timeScanner = new Date(inizio);
            timeScanner.setSeconds(0,0); 

            let fineMs = fine.getTime();
            let currentMs = timeScanner.getTime();
            
            while(currentMs < fineMs) {
                let tempDate = new Date(currentMs);
                let cat = getCategoriaOraria(tempDate);
                dettagli[cat] += (1/60);
                currentMs += 60000;
            }

            let turnoRientro = getTurno(new Date(fine.getTime() - 1000));

            ultimoCalcoloDettagli = dettagli;

            let record = {
                id: Date.now(),
                tipo: tipo,
                inizio: inizio.toISOString(),
                fine: fine.toISOString(),
                totale: totaleOre.toFixed(2),
                rientro: turnoRientro,
                segmenti: segmenti,
                dettagli: dettagli,
                note: note
            };
            salvaRecord(record);

            mostraRisultatoBox(totaleOre, segmenti, turnoRientro);
        }

        function mostraRisultatoBox(totale, segmenti, turnoRientro) {
            let htmlRes = `<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                            <strong style="text-transform:uppercase;">Totale Calcolato</strong> 
                            <span style="font-size:1.6em; font-weight:800; color:var(--vvf-rosso); font-family:monospace;">${totale.toFixed(2)}h</span>
                           </div>`;
            
            segmenti.forEach(s => {
                htmlRes += `<div style="margin-bottom:4px; font-size:13px; font-family:monospace;">
                                > ${s.ore.toFixed(2)}h su <span class="badge bg-${s.turno}" style="font-size:0.8em; padding:1px 6px;">${s.turno}</span>
                            </div>`;
            });
            
            htmlRes += `<div style="margin-top:15px; border-top:1px dashed var(--tech-border); padding-top:10px; font-size:12px; color:var(--tech-dark);">
                        <b style="color:var(--vvf-rosso);">TURNO DI ASSEGNAZIONE:</b> <span class="badge bg-${turnoRientro}" style="font-size:1.1em;">${turnoRientro}</span></div>`;
            
            let box = document.getElementById('risultato-box');
            box.innerHTML = htmlRes;
            box.style.display = 'block';
            document.getElementById('btn-vedi-dettaglio').classList.remove('hidden');
        }

        // ===============================================
        //  4. GESTIONE VIEW DETTAGLI
        // ===============================================

        function mostraDettaglioUltimo() {
            // Passa anche le note correnti se presenti
            let noteCorrenti = document.getElementById('note').value;
            if(ultimoCalcoloDettagli) renderizzaDettagli(ultimoCalcoloDettagli, noteCorrenti);
        }

        function mostraDettaglioDaStorico(id) {
            let list = JSON.parse(localStorage.getItem(getHistoryKey()) || '[]');
            let item = list.find(x => x.id === id);
            if(item && item.dettagli) {
                // Passa anche le note salvate nello storico
                renderizzaDettagli(item.dettagli, item.note);
            } else {
                alert("Dati tecnici non disponibili per questo record.");
            }
        }

        // FUNZIONE PER CONVERTIRE ORE DECIMALI IN ORE E MINUTI
        function formattaOreMinuti(oreDecimali) {
            let ore = Math.floor(oreDecimali);
            let minuti = Math.round((oreDecimali - ore) * 60);
            return `${ore}h ${String(minuti).padStart(2, '0')}m`;
        }

        function renderizzaDettagli(d, note) {
            let html = `
                <table class="detail-table">
                    <tr>
                        <td class="detail-label">Feriali (06:00-22:00)</td>
                        <td class="detail-val" style="color:var(--tech-dark)">${formattaOreMinuti(d.feriale)}</td>
                    </tr>
                    <tr>
                        <td class="detail-label">Festivi (06:00-22:00)</td>
                        <td class="detail-val" style="color:var(--vvf-oro)">${formattaOreMinuti(d.festivo)}</td>
                    </tr>
                    <tr>
                        <td class="detail-label">Super Festivi (06:00-22:00)</td>
                        <td class="detail-val" style="color:var(--vvf-rosso)">${formattaOreMinuti(d.super_festivo)}</td>
                    </tr>
                    <tr>
                        <td class="detail-label">Notturne (22:00-06:00)</td>
                        <td class="detail-val" style="color:var(--vvf-rosso); border-bottom:2px solid var(--vvf-rosso);">${formattaOreMinuti(d.notturno)}</td>
                    </tr>
                    <tr style="background:rgba(0,0,0,0.02);">
                        <td style="font-weight:bold;">TOTALE OPERATIVO</td>
                        <td class="detail-val">${formattaOreMinuti(d.feriale+d.festivo+d.super_festivo+d.notturno)}</td>
                    </tr>
                </table>
                <p style="font-size:11px; color:#666; margin-top:10px; font-style:italic;">
                    * NOTA TECNICA: Fasce Feriali/Festive valide SOLO 06:00-22:00. Altro = Notturno.
                </p>
            `;

            // Aggiunge le note se presenti
            if (note && note.trim() !== "") {
                html += `
                    <div class="detail-notes">
                        <strong style="color:var(--vvf-rosso); text-transform:uppercase; font-size:11px;">Note Operative:</strong><br>
                        ${note}
                    </div>
                `;
            }
            
            document.getElementById('detail-content').innerHTML = html;
            document.getElementById('view-app').classList.add('hidden');
            document.getElementById('view-detail').classList.remove('hidden');
        }

        function chiudiDettaglio() {
            document.getElementById('view-detail').classList.add('hidden');
            document.getElementById('view-app').classList.remove('hidden');
        }

        // ===============================================
        //  5. PERSISTENZA STORICO
        // ===============================================

        function getHistoryKey() { return `vvf_history_${currentUser}`; }

        function salvaRecord(record) {
            let key = getHistoryKey();
            let list = JSON.parse(localStorage.getItem(key) || '[]');
            list.unshift(record);
            localStorage.setItem(key, JSON.stringify(list));
            caricaStorico();
        }

        function caricaStorico() {
            let list = JSON.parse(localStorage.getItem(getHistoryKey()) || '[]');
            let container = document.getElementById('lista-storico');
            
            if (list.length === 0) { container.innerHTML = '<p style="text-align:center; font-size:12px; color:#999; font-family:monospace;">NESSUN DATO IN MEMORIA</p>'; return; }

            let html = '';
            list.forEach(item => {
                let dIniz = new Date(item.inizio);
                let dFin = new Date(item.fine);
                let dataStr = dIniz.toLocaleDateString('it-IT', {day:'numeric', month:'short'}).toUpperCase();
                
                html += `
                <div class="history-item">
                    <div class="history-header">
                        <span class="history-date">${dataStr}</span>
                        <span class="badge bg-${item.rientro}" style="transform:scale(0.8)">${item.rientro}</span>
                    </div>
                    <div class="history-sub">
                        <strong style="color:var(--vvf-rosso);">${item.tipo.toUpperCase()}</strong> <span style="color:#aaa;">|</span> ${item.totale}h <br>
                    </div>
                    <div class="history-actions">
                        <button class="ghost" style="padding:4px 8px; width:auto; font-size:10px; margin:0; border-color:var(--tech-border);" onclick="mostraDettaglioDaStorico(${item.id})">INFO</button>
                        <button class="btn-delete" style="margin:0; font-size:10px;" onclick="eliminaRecord(${item.id})">Rimuovi</button>
                    </div>
                </div>`;
            });
            container.innerHTML = html;
        }

        function eliminaRecord(id) {
            if(!confirm("Confermi rimozione record dal database locale?")) return;
            let key = getHistoryKey();
            let list = JSON.parse(localStorage.getItem(key) || '[]');
            localStorage.setItem(key, JSON.stringify(list.filter(x => x.id !== id)));
            caricaStorico();
        }

        function resetStorico() {
            if(confirm("ATTENZIONE: Cancellazione completa del database locale. Procedere?")) { localStorage.removeItem(getHistoryKey()); caricaStorico(); }
        }
    </script>
</body>
</html>
