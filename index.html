<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>VVF Smart - Terminale Operativo</title>
    
    <!-- PWA CONFIG -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#ce3824">
    <link rel="apple-touch-icon" href="https://upload.wikimedia.org/wikipedia/commons/thumb/c/cc/Vigili_del_Fuoco_Italy.svg/240px-Vigili_del_Fuoco_Italy.svg.png">

    <!-- LIBRERIE PDF (jsPDF) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

    <!-- FONT EXO 2 -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Exo+2:ital,wght@0,300;0,400;0,500;0,600;0,700;0,800;1,400&display=swap" rel="stylesheet">

    <style>
        /* --- CONFIGURAZIONE COLORI & FONT --- */
        :root {
            --vvf-verde: #4d8b55;
            --vvf-oro: #c5a065;
            --vvf-crema: #f2efe4;
            --vvf-rosso: #ce3824;
            --vvf-grigio: #9e9e9e;
            --tech-dark: #1a1a2e;
            --tech-border: #bac9d0;
            --tech-grid: rgba(0, 0, 0, 0.05);
            --tech-overlay: rgba(255, 255, 255, 0.94);
        }

        body { 
            font-family: 'Exo 2', sans-serif;
            background-color: var(--vvf-crema); 
            margin: 0; padding: 20px 15px; 
            padding-top: env(safe-area-inset-top, 20px);
            padding-bottom: env(safe-area-inset-bottom, 20px);
            color: var(--tech-dark);
            -webkit-font-smoothing: antialiased;
            overflow-x: hidden;
            background-image: 
                linear-gradient(var(--tech-grid) 1px, transparent 1px),
                linear-gradient(90deg, var(--tech-grid) 1px, transparent 1px);
            background-size: 20px 20px;
        }

        /* SFONDO ANIMATO */
        .tech-background-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; pointer-events: none; overflow: hidden; display: flex; align-items: center; justify-content: center; }
        .tech-bg-drawing { position: absolute; width: 90%; max-width: 600px; opacity: 0; fill: none; stroke: rgba(0, 0, 0, 0.15); stroke-width: 1.5; stroke-linejoin: round; stroke-linecap: round; animation: cycleDrawings 24s infinite; }
        .tech-bg-drawing:nth-child(1) { animation-delay: 0s; }
        .tech-bg-drawing:nth-child(2) { animation-delay: 6s; }
        .tech-bg-drawing:nth-child(3) { animation-delay: 12s; }
        .tech-bg-drawing:nth-child(4) { animation-delay: 18s; }
        @keyframes cycleDrawings { 0% { opacity: 0; transform: scale(0.98); } 5% { opacity: 1; transform: scale(1); } 20% { opacity: 1; transform: scale(1); } 25% { opacity: 0; transform: scale(1.02); } 100% { opacity: 0; } }

        /* CARD STYLE */
        .card { 
            background: var(--tech-overlay); padding: 25px 20px; margin-bottom: 25px; position: relative;
            border: 1px solid var(--tech-border); border-left: 4px solid var(--vvf-rosso);
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            clip-path: polygon(0 0, 100% 0, 100% calc(100% - 15px), calc(100% - 15px) 100%, 0 100%);
        }
        .card::before { content: ''; position: absolute; top: 0; right: 0; width: 15px; height: 15px; border-top: 2px solid var(--vvf-oro); border-right: 2px solid var(--vvf-oro); }

        .header { text-align: center; margin-bottom: 30px; position: relative; z-index: 2; }
        .logo-container { width: 140px; height: 90px; margin: 0 auto 15px auto; display: flex; align-items: center; justify-content: center; }
        .logo-svg { width: 100%; height: 100%; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1)); }
        .header h1 { color: var(--vvf-rosso); margin: 0; font-size: 22px; font-weight: 800; text-transform: uppercase; letter-spacing: 1px; border-bottom: 2px solid var(--vvf-oro); display: inline-block; padding-bottom: 5px; }
        .header p { color: var(--vvf-grigio); font-size: 11px; margin-top: 8px; font-weight: 600; text-transform: uppercase; letter-spacing: 3px; }

        /* INPUT & FORM */
        label { font-weight: 700; font-size: 11px; display: block; margin-top: 15px; margin-bottom: 5px; color: var(--tech-dark); text-transform: uppercase; letter-spacing: 1px; border-left: 3px solid var(--vvf-oro); padding-left: 8px; }
        input, select, textarea { width: 100%; padding: 12px; border: 1px solid var(--tech-border); background: rgba(255,255,255,0.8); font-size: 15px; font-family: 'Exo 2', sans-serif; color: var(--tech-dark); box-sizing: border-box; transition: all 0.3s; border-radius: 0; }
        input:focus, select:focus, textarea:focus { outline: none; border-color: var(--vvf-rosso); background: #fff; box-shadow: inset 3px 0 0 var(--vvf-rosso); }

        /* BUTTONS */
        button { background-color: var(--vvf-rosso); color: white; border: none; padding: 16px; width: 100%; font-size: 14px; font-weight: 700; cursor: pointer; margin-top: 25px; text-transform: uppercase; letter-spacing: 1px; border-bottom: 3px solid rgba(0,0,0,0.2); }
        button:active { transform: translateY(2px); border-bottom: 1px solid rgba(0,0,0,0.2); }
        button.secondary { background-color: var(--vvf-oro); color: #333; }
        button.pdf-btn { background-color: var(--tech-dark); color: white; margin-top: 10px; }
        button.ghost { background-color: transparent; color: var(--vvf-grigio); border: 1px dashed var(--tech-border); margin-top: 15px; padding: 10px; font-size: 11px; }
        
        .btn-settings { position: absolute; top: 0; right: 0; background: none; border: none; color: var(--vvf-grigio); font-size: 20px; padding: 10px; cursor: pointer; width: auto; margin:0; box-shadow: none; }

        /* UI ELEMENTS */
        .login-msg { font-size: 12px; text-align: center; margin-bottom: 20px; color: var(--tech-dark); font-style: italic; }
        .text-link { color: var(--vvf-grigio); font-size: 10px; text-decoration: underline; cursor: pointer; margin-top: 10px; text-align: right; font-weight: 600; text-transform: uppercase; }
        
        /* BADGES */
        .badge { display: inline-flex; align-items: center; justify-content: center; padding: 3px 8px; color: white; font-weight: 700; font-size: 0.85em; min-width: 25px; text-align: center; }
        .bg-A { background-color: var(--vvf-rosso); } .bg-B { background-color: var(--vvf-verde); } .bg-C { background-color: var(--vvf-oro); color: #333; } .bg-D { background-color: var(--tech-dark); }

        /* RISULTATI */
        .result-box { background-color: rgba(255,255,255,0.95); border: 1px solid var(--vvf-verde); border-left-width: 5px; padding: 15px; margin-top: 25px; display: none; position: relative; }
        .result-money { float: right; color: var(--vvf-verde); font-size: 1.2em; font-weight: 800; }

        /* STORICO */
        .history-item { border-bottom: 1px dashed var(--tech-border); padding: 12px 0; display: flex; flex-direction: column; gap: 6px; transition: opacity 0.3s; }
        .history-item.visto { opacity: 0.5; filter: grayscale(80%); }
        .history-header { display: flex; justify-content: space-between; align-items: center; }
        .history-date { font-weight: 700; color: var(--tech-dark); font-size: 13px; text-transform: uppercase; }
        .history-sub { font-size: 11px; color: #666; font-family: monospace; }
        .history-actions { display: flex; justify-content: flex-end; gap: 10px; align-items: center; }
        
        /* Checkbox Tecnico */
        .check-container { display: flex; align-items: center; cursor: pointer; font-size: 9px; color: var(--vvf-grigio); font-weight: bold; text-transform: uppercase; }
        .check-box { width: 14px; height: 14px; border: 2px solid var(--tech-border); margin-right: 5px; display: flex; align-items: center; justify-content: center; }
        .history-item.visto .check-box { background-color: var(--vvf-verde); border-color: var(--vvf-verde); }
        .history-item.visto .check-box::after { content: '‚úî'; color: white; font-size: 10px; }

        /* CHECKBOX LOGIN (Auto-Login) */
        .login-checkbox {
            display: flex; align-items: center; justify-content: center;
            margin-top: 15px; font-size: 11px; color: var(--vvf-rosso);
            font-weight: 700; cursor: pointer; text-transform: uppercase;
        }
        .login-checkbox input { width: auto; margin-right: 8px; }

        /* TABELLA DETTAGLI */
        .detail-table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 12px; }
        .detail-table td { padding: 8px; border-bottom: 1px solid var(--tech-border); }
        .detail-val { text-align: right; font-weight: 700; font-family: monospace; }

        /* VIGILANZA STYLE */
        .vigilanza-box { background: rgba(255,255,255,0.5); border: 1px dashed var(--vvf-oro); padding: 10px; margin-top: 10px; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }

        .hidden { display: none !important; }
    </style>
</head>
<body>

    <!-- SFONDO ANIMATO -->
    <div class="tech-background-container">
        <!-- Disegni tecnici vettoriali -->
        <svg class="tech-bg-drawing" viewBox="0 0 400 200"><path d="M50 150 L350 150 M40 150 L60 150 M40 150 L40 80 L50 60 L130 60 L130 150 M135 55 L365 55 L365 150 L135 150" stroke="rgba(0,0,0,0.15)" /><circle cx="90" cy="150" r="22" stroke="rgba(0,0,0,0.15)" /><circle cx="310" cy="150" r="22" stroke="rgba(0,0,0,0.15)" /></svg>
        <svg class="tech-bg-drawing" viewBox="0 0 400 200"><path d="M50 150 L350 150 L350 110 L105 110 L100 150 L50 150 M150 100 L380 40" stroke="rgba(0,0,0,0.15)" /><circle cx="80" cy="150" r="20" stroke="rgba(0,0,0,0.15)" /><circle cx="280" cy="150" r="20" stroke="rgba(0,0,0,0.15)" /></svg>
        <svg class="tech-bg-drawing" viewBox="0 0 400 200"><path d="M100 100 C 100 70, 140 60, 200 60 C 260 60, 280 70, 280 100 C 280 130, 240 140, 180 140 C 140 140, 100 130, 100 100 M50 45 L350 45" stroke="rgba(0,0,0,0.15)" /></svg>
    </div>

    <!-- LOGO GLOBALE -->
    <div style="text-align: center; margin-top: 40px;">
        <div class="logo-container">
            <svg class="logo-svg" viewBox="0 0 120 70" xmlns="http://www.w3.org/2000/svg">
                <style> .tech-line { fill: none; stroke: var(--vvf-rosso); stroke-width: 2.5; stroke-linecap: round; stroke-linejoin: round; } .tech-detail { fill: none; stroke: var(--vvf-rosso); stroke-width: 1.5; } .tech-accent { fill: none; stroke: var(--vvf-oro); stroke-width: 2; } .tech-light { fill: var(--vvf-oro); stroke: none; } </style>
                <path class="tech-line" d="M15 45 L15 25 L25 15 L40 15 L40 45 Z" /> <path class="tech-detail" d="M25 15 L25 25 L40 25" /> <path class="tech-line" d="M42 45 L42 15 L105 15 L105 45" /> <line class="tech-detail" x1="55" y1="20" x2="55" y2="40" /> <line class="tech-detail" x1="70" y1="20" x2="70" y2="40" /> <line class="tech-detail" x1="85" y1="20" x2="85" y2="40" /> <rect class="tech-detail" x="45" y="18" width="55" height="24" rx="2" /> <path class="tech-line" d="M10 45 L25 45 M55 45 L85 45 M115 45 L105 45" /> <circle class="tech-line" cx="40" cy="45" r="8" /> <circle class="tech-line" cx="95" cy="45" r="8" /> <path class="tech-accent" d="M45 12 L100 8" /> <path class="tech-light" d="M30 15 L30 10 L36 10 L36 15 Z" />
            </svg>
        </div>
    </div>

    <!-- SCHERMATA LOGIN -->
    <div id="view-login">
        <div class="header">
            <h1>INSERIMENTO ORE MISSIONE</h1>
            <p>VIGILI DEL FUOCO SIENA</p>
        </div>
        <div class="card">
            <p class="login-msg" id="login-intro">ACCESSO AL SISTEMA</p>
            <label>Identificativo Utente</label> <input type="text" id="username" placeholder="ES. MARCOROSSI" oninput="resetLoginUI()">
            <div id="password-section" class="hidden">
                <label>Codice Sicurezza</label> <input type="password" id="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                
                <!-- CHECKBOX RESTA COLLEGATO -->
                <label class="login-checkbox">
                    <input type="checkbox" id="remember-me"> RESTA COLLEGATO
                </label>

                <div class="text-link" onclick="toggleRecovery()">PASSWORD SMARRITA?</div>
            </div>
            <div id="register-section" class="hidden">
                <p style="color: var(--vvf-oro); font-size: 11px; margin-top: 15px; border: 1px dashed var(--vvf-oro); padding: 5px;">CONFIGURAZIONE NUOVO PROFILO</p>
                <label>Qualifica (x Ordinario)</label> <select id="reg-qualifica"></select>
                <label>Crea Password</label> <input type="password" id="new-password" placeholder="SCEGLI PASSWORD">
                <label>PIN di Recupero</label> <input type="number" id="recovery-pin" placeholder="ES. 1234" maxlength="6">
            </div>
            <div id="recovery-section" class="hidden" style="margin-top: 20px; border-top: 1px dashed var(--vvf-grigio); padding-top: 20px;">
                <p style="color: var(--vvf-rosso); font-weight: 700; font-size: 12px;">RIPRISTINO CREDENZIALI</p>
                <label>PIN di Sicurezza</label> <input type="number" id="check-recovery-pin" placeholder="PIN SALVATO">
                <label>Nuova Password</label> <input type="password" id="reset-password" placeholder="NUOVA PASSWORD">
                <div class="text-link" onclick="toggleRecovery()" style="text-align: left; margin-top: 10px;">ANNULLA</div>
            </div>
            <p id="error-text" class="error-msg" style="display:none; color:var(--vvf-rosso); text-align:center; margin-top:10px;">ERRORE</p>
            <button id="btn-login-action" onclick="checkUser()">PROCEDI</button>
        </div>
    </div>

    <!-- SCHERMATA APP -->
    <div id="view-app" class="hidden">
        <div class="header">
            <button class="btn-settings" onclick="apriImpostazioni()">‚öôÔ∏è</button>
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 5px;">
                <h1 style="font-size: 18px; border:none; padding:0;">REGISTRO OPERATIVO</h1>
                <span id="user-badge" style="background:var(--tech-dark); color:white; padding:4px 10px; font-size:10px; font-weight:bold; letter-spacing:1px;">USER</span>
            </div>
            <div class="info-turno-box">
                <div>
                    <strong id="data-live" style="font-size: 16px; color: var(--tech-dark); text-transform: uppercase;">-- -- ----</strong>
                    <span style="font-size: 11px; color: #666; display:block; margin-top:2px; font-family:monospace;">ORA LOCALE: <span id="orario-live">--:--</span></span>
                </div>
                <div id="oggi-turno-badge">...</div>
            </div>
        </div>

        <!-- BOTTONE REPORT -->
        <button class="pdf-btn" onclick="apriReport()">üìÑ REPORT E PDF</button>

        <div class="card" style="margin-top:15px;">
            <label>Tipologia Intervento</label>
            <select id="tipo" onchange="toggleVigilanzaUI()">
                <option value="Soccorso">üî• STRAORDINARIO SOCCORSO</option>
                <option value="Guida">üöí ORE DI GUIDA</option>
                <option value="Boschivo">üå≤ AIB / BOSCHIVO</option>
                <option value="Vigilanza">üëÆ SERVIZIO DI VIGILANZA</option>
                <option value="Decreto81">‚ö†Ô∏è DECRETO 81</option>
            </select>
            <div id="box-vigilanza" class="hidden vigilanza-box">
                <label style="color:var(--vvf-rosso);">LUOGO VIGILANZA (Obbligatorio)</label> <select id="luogo-vigilanza"></select>
            </div>
            <label>Inizio Operazioni</label> <input type="datetime-local" id="inizio">
            <label>Fine Operazioni</label> <input type="datetime-local" id="fine">
            <label>Note Operative</label> <textarea id="note" rows="2" placeholder="RIFERIMENTI INTERVENTO..."></textarea>
            <button onclick="calcolaESalva()">REGISTRA E CALCOLA</button>
            <div id="risultato-box" class="result-box"></div>
            <button id="btn-vedi-dettaglio" class="secondary hidden" onclick="mostraDettaglioUltimo()">ANALISI ECONOMICA E FASCE</button>
        </div>

        <div class="card">
            <h3 style="color: var(--vvf-rosso); margin-top:0; text-transform: uppercase; font-size: 14px; letter-spacing: 1px; border-bottom: 2px solid var(--tech-grid); padding-bottom: 10px;">Archivio Storico</h3>
            <div id="lista-storico"></div>
            <button class="ghost" onclick="resetStorico()">RESET DATABASE</button>
        </div>
        <button class="ghost" onclick="logout()" style="border-style: solid; border-color: var(--tech-dark); color: var(--tech-dark);">DISCONNESSIONE</button>
    </div>

    <!-- SCHERMATA IMPOSTAZIONI -->
    <div id="view-settings" class="hidden">
        <div class="header">
            <h1 style="font-size: 20px;">CONFIGURAZIONE</h1>
            <p>PARAMETRI UTENTE</p>
        </div>
        <div class="card">
            <label>Qualifica (per Soccorso/Guida)</label> <select id="settings-qualifica" onchange="aggiornaTariffeSettings()"></select>
            <div style="margin-top:20px; border-top:1px dashed var(--tech-border); padding-top:10px;">
                <p style="font-size:11px; color:var(--vvf-rosso); font-weight:bold; margin-bottom:10px;">TARIFFE QUALIFICA (AUTOMATICHE)</p>
                <label>Feriale</label> <input type="number" step="0.01" id="tariffa-feriale">
                <label>Festivo/Notturno</label> <input type="number" step="0.01" id="tariffa-mista">
                <label>Festivo Notturno</label> <input type="number" step="0.01" id="tariffa-festnotte">
            </div>
            <div style="margin-top:20px; border-top:1px dashed var(--tech-border); padding-top:10px; background:rgba(0,0,0,0.02); padding:10px;">
                <p style="font-size:11px; color:var(--vvf-verde); font-weight:bold; margin-bottom:10px;">TARIFFE SPECIALI (MANUALI)</p>
                <label>Vigilanza (‚Ç¨/h)</label> <input type="number" step="0.01" id="tariffa-vigilanza">
                <label>Decreto 81 (‚Ç¨/h)</label> <input type="number" step="0.01" id="tariffa-decreto81">
            </div>
            <button onclick="salvaImpostazioni()">SALVA MODIFICHE</button>
            <button class="ghost" onclick="chiudiImpostazioni()">ANNULLA</button>
        </div>
    </div>

    <!-- SCHERMATA REPORT/PDF -->
    <div id="view-report" class="hidden">
        <div class="header">
            <h1 style="font-size: 20px;">ESPORTAZIONE</h1>
            <p>GENERAZIONE DOCUMENTI</p>
        </div>
        <div class="card">
            <label>Dal Giorno</label>
            <input type="date" id="pdf-start">
            <label>Al Giorno</label>
            <input type="date" id="pdf-end">
            
            <button class="pdf-btn" onclick="generaPDF()">SCARICA PDF</button>
            <button class="ghost" onclick="chiudiReport()">INDIETRO</button>
        </div>
    </div>

    <!-- SCHERMATA DETTAGLIO -->
    <div id="view-detail" class="hidden">
        <div class="header"> <h1 style="font-size: 20px;">DETTAGLIO TECNICO</h1> <p>RIPARTIZIONE E IMPORTI</p> </div>
        <div class="card"> <div id="detail-content"></div> <button class="secondary" onclick="chiudiDettaglio()">CHIUDI SCHEDA</button> </div>
    </div>

    <script>
        // CONFIGURAZIONE VARIABILI
        const DATI_QUALIFICHE = { 'allievo': { label: 'Allievo VVF', feriale: 13.94, mista: 15.76, festNotte: 18.18 }, 'vigile': { label: 'Vigile del Fuoco', feriale: 13.94, mista: 15.76, festNotte: 18.18 }, 'vigile_esp': { label: 'Vigile Esperto', feriale: 14.33, mista: 16.20, festNotte: 18.69 }, 'vigile_coord': { label: 'Vigile Coord.', feriale: 15.16, mista: 17.13, festNotte: 19.77 }, 'vigile_scatto': { label: 'Vigile Coord. + Scatto', feriale: 15.81, mista: 17.88, festNotte: 20.63 }, 'capo_squadra': { label: 'Capo Squadra', feriale: 15.81, mista: 17.88, festNotte: 20.63 }, 'cs_esperto': { label: 'Capo Squadra Esp.', feriale: 16.17, mista: 18.28, festNotte: 21.09 }, 'capo_reparto': { label: 'Capo Reparto', feriale: 16.36, mista: 18.50, festNotte: 21.35 }, 'cr_scatto': { label: 'Capo Reparto + Scatto', feriale: 17.04, mista: 19.27, festNotte: 22.23 } };
        const LUOGHI_VIGILANZA = ["FIERA", "MANIFESTAZIONE", "PALA MONTEPASCHI", "PALAESTRA", "PALIO", "PROVA PALIO", "STADIO", "TEATRO CHIGI SARACINI", "TEATRO DEI RINNOVATI", "TEATRO DEI ROZZI", "TEATRO DEL POPOLO", "TEATRO POLITEAMA", "TEATRO SANT'AGOSTINO"].sort();
        const sequenzaTurni = ['C', 'B', 'D', 'C', 'A', 'D', 'B', 'A']; const dataAncora = new Date(2025, 11, 1, 8, 0, 0); const superFestiviFissi = ["1/1", "6/1", "25/4", "1/5", "2/6", "15/8", "1/11", "8/12", "25/12", "26/12"];
        const LAST_USER_KEY = 'vvf_active_session'; // Chiave per auto-login

        let dbUtenti = JSON.parse(localStorage.getItem('vvf_users_db') || '{}');
        let currentUser = null;
        let loginState = 'check';
        let userRates = null;
        let ultimoCalcoloDettagli = null;

        // --- AVVIO E AUTO-LOGIN ---
        document.addEventListener('DOMContentLoaded', () => { 
            let selLuoghi = document.getElementById('luogo-vigilanza'); 
            selLuoghi.innerHTML = ""; 
            LUOGHI_VIGILANZA.forEach(luogo => { let opt = document.createElement('option'); opt.value = luogo; opt.text = luogo; selLuoghi.add(opt); }); 
            
            // Auto-login Check
            let activeUser = localStorage.getItem(LAST_USER_KEY);
            if(activeUser && dbUtenti[activeUser]) {
                avviaApp(activeUser);
            }
        });

        // Questa √® la funzione che mancava nella v9!
        function popolaSelectQualifiche(idSelect) {
            let sel = document.getElementById(idSelect);
            if (!sel) return;
            sel.innerHTML = "";
            for (let k in DATI_QUALIFICHE) {
                let opt = document.createElement('option');
                opt.value = k;
                opt.text = DATI_QUALIFICHE[k].label;
                sel.add(opt);
            }
        }

        // Funzioni App
        function checkUser() { 
            let user = document.getElementById('username').value.trim(); 
            if(!user) return; 
            
            if (loginState === 'check') { 
                if (dbUtenti.hasOwnProperty(user)) { 
                    document.getElementById('password-section').classList.remove('hidden'); 
                    document.getElementById('btn-login-action').innerText = "ACCESSO"; 
                    loginState = 'login'; 
                    document.getElementById('username').disabled = true; 
                } else { 
                    document.getElementById('register-section').classList.remove('hidden'); 
                    popolaSelectQualifiche('reg-qualifica'); // POPOLA MENU REGISTRAZIONE
                    document.getElementById('btn-login-action').innerText = "REGISTRAZIONE"; 
                    loginState = 'register'; 
                    document.getElementById('username').disabled = true; 
                } 
            } else if (loginState === 'login') { 
                let pass = document.getElementById('password').value; 
                let uData = dbUtenti[user]; 
                if ((typeof uData === 'string' && uData === pass) || (typeof uData === 'object' && uData.password === pass)) { 
                    if(document.getElementById('remember-me').checked) localStorage.setItem(LAST_USER_KEY, user);
                    avviaApp(user); 
                } else { 
                    document.getElementById('error-text').style.display = 'block'; 
                } 
            } else if (loginState === 'register') { 
                let p = document.getElementById('new-password').value; 
                let pin = document.getElementById('recovery-pin').value; 
                let q = document.getElementById('reg-qualifica').value; 
                if(p && pin) { 
                    dbUtenti[user] = { password: p, pin: pin, qualifica: q, tariffe: { ...DATI_QUALIFICHE[q], vigilanza: 0, decreto81: 0 } }; 
                    localStorage.setItem('vvf_users_db', JSON.stringify(dbUtenti)); 
                    avviaApp(user); 
                } else { alert("Compila tutti i campi."); } 
            } 
        }

        function avviaApp(user) { currentUser = user; let uData = dbUtenti[user]; if(!uData.tariffe) { uData.qualifica = 'vigile'; uData.tariffe = { ...DATI_QUALIFICHE['vigile'], vigilanza: 0, decreto81: 0 }; dbUtenti[user] = uData; localStorage.setItem('vvf_users_db', JSON.stringify(dbUtenti)); } if(uData.tariffe.vigilanza === undefined) uData.tariffe.vigilanza = 0; if(uData.tariffe.decreto81 === undefined) uData.tariffe.decreto81 = 0; userRates = uData.tariffe; document.getElementById('view-login').classList.add('hidden'); document.getElementById('view-app').classList.remove('hidden'); document.getElementById('user-badge').innerText = user.toUpperCase(); impostaDateDefault(); aggiornaLiveUI(); setInterval(aggiornaLiveUI, 60000); caricaStorico(); }
        function toggleVigilanzaUI() { let tipo = document.getElementById('tipo').value; let box = document.getElementById('box-vigilanza'); if (tipo === 'Vigilanza') box.classList.remove('hidden'); else box.classList.add('hidden'); }
        function calcolaESalva() { let inizio = new Date(document.getElementById('inizio').value); let fine = new Date(document.getElementById('fine').value); let tipo = document.getElementById('tipo').value; let note = document.getElementById('note').value; let luogoVigilanza = (tipo === 'Vigilanza') ? document.getElementById('luogo-vigilanza').value : ""; if (fine <= inizio) { alert("Data fine precedente a inizio!"); return; } let segmenti = []; let cursore = new Date(inizio); let totaleOre = 0; while (cursore < fine) { let prox = new Date(cursore); let ora = cursore.getHours(); if (ora >= 8 && ora < 20) prox.setHours(20, 0, 0, 0); else { if (ora >= 20) prox.setDate(prox.getDate() + 1); prox.setHours(8, 0, 0, 0); } let endSeg = (prox < fine) ? prox : fine; let dur = (endSeg - cursore) / 3600000; let pm = new Date(cursore.getTime() + (endSeg - cursore)/2); segmenti.push({ turno: getTurno(pm), ore: dur }); totaleOre += dur; cursore = endSeg; } let dett = null; let importo = 0; let isSpecialRate = (tipo === 'Vigilanza' || tipo === 'Decreto81'); if (isSpecialRate) { let rate = (tipo === 'Vigilanza') ? userRates.vigilanza : userRates.decreto81; importo = totaleOre * rate; dett = { mode: 'flat', rate: rate }; } else { dett = { mode: 'complex', feriale: 0, mista: 0, festNotte: 0 }; let scanner = new Date(inizio); scanner.setSeconds(0,0); let fineMs = fine.getTime(); while(scanner.getTime() < fineMs) { let cat = getCategoriaOraria(scanner); dett[cat] += (1/60); scanner.setMinutes(scanner.getMinutes() + 1); } importo = (dett.feriale * userRates.feriale) + (dett.mista * userRates.mista) + (dett.festNotte * userRates.festNotte); } let turnoRientro = getTurno(new Date(fine.getTime() - 1000)); ultimoCalcoloDettagli = { tipo: tipo, fasce: dett, soldi: importo, luogo: luogoVigilanza, oreTot: totaleOre }; let record = { id: Date.now(), tipo: tipo, luogo: luogoVigilanza, inizio: inizio.toISOString(), fine: fine.toISOString(), totale: totaleOre, rientro: turnoRientro, segmenti: segmenti, dettagli: dett, importo: importo, note: note, visto: false }; salvaRecord(record); mostraRisultatoBox(totaleOre, importo, turnoRientro); }
        function apriImpostazioni() { document.getElementById('view-app').classList.add('hidden'); document.getElementById('view-settings').classList.remove('hidden'); popolaSelectQualifiche('settings-qualifica'); let uData = dbUtenti[currentUser]; document.getElementById('settings-qualifica').value = uData.qualifica; document.getElementById('tariffa-feriale').value = uData.tariffe.feriale; document.getElementById('tariffa-mista').value = uData.tariffe.mista; document.getElementById('tariffa-festnotte').value = uData.tariffe.festNotte; document.getElementById('tariffa-vigilanza').value = uData.tariffe.vigilanza; document.getElementById('tariffa-decreto81').value = uData.tariffe.decreto81; }
        function aggiornaTariffeSettings() { let newQ = document.getElementById('settings-qualifica').value; let def = DATI_QUALIFICHE[newQ]; document.getElementById('tariffa-feriale').value = def.feriale; document.getElementById('tariffa-mista').value = def.mista; document.getElementById('tariffa-festnotte').value = def.festNotte; }
        function salvaImpostazioni() { let uData = dbUtenti[currentUser]; uData.qualifica = document.getElementById('settings-qualifica').value; uData.tariffe.feriale = parseFloat(document.getElementById('tariffa-feriale').value); uData.tariffe.mista = parseFloat(document.getElementById('tariffa-mista').value); uData.tariffe.festNotte = parseFloat(document.getElementById('tariffa-festnotte').value); uData.tariffe.label = DATI_QUALIFICHE[uData.qualifica].label; uData.tariffe.vigilanza = parseFloat(document.getElementById('tariffa-vigilanza').value) || 0; uData.tariffe.decreto81 = parseFloat(document.getElementById('tariffa-decreto81').value) || 0; dbUtenti[currentUser] = uData; localStorage.setItem('vvf_users_db', JSON.stringify(dbUtenti)); userRates = uData.tariffe; chiudiImpostazioni(); }
        function chiudiImpostazioni() { document.getElementById('view-settings').classList.add('hidden'); document.getElementById('view-app').classList.remove('hidden'); }
        function apriReport() { document.getElementById('view-app').classList.add('hidden'); document.getElementById('view-report').classList.remove('hidden'); let d = new Date(); let y = d.getFullYear(), m = d.getMonth(); document.getElementById('pdf-start').value = new Date(y, m, 1).toISOString().slice(0,10); document.getElementById('pdf-end').value = new Date(y, m+1, 0).toISOString().slice(0,10); }
        function chiudiReport() { document.getElementById('view-report').classList.add('hidden'); document.getElementById('view-app').classList.remove('hidden'); }
        function generaPDF() { const { jsPDF } = window.jspdf; const doc = new jsPDF(); let startStr = document.getElementById('pdf-start').value; let endStr = document.getElementById('pdf-end').value; if(!startStr || !endStr) { alert("Seleziona le date."); return; } let start = new Date(startStr); let end = new Date(endStr); end.setHours(23, 59, 59); let list = JSON.parse(localStorage.getItem(getHistoryKey()) || '[]'); let filtered = list.filter(item => { let d = new Date(item.inizio); return d >= start && d <= end; }).reverse(); if(filtered.length === 0) { alert("Nessun dato nel periodo selezionato."); return; } doc.setFontSize(16); doc.setTextColor(206, 56, 36); doc.text("VIGILI DEL FUOCO SIENA", 105, 20, null, null, "center"); doc.setFontSize(11); doc.setTextColor(0, 0, 0); doc.text(`Riepilogo Prestazioni - Utente: ${currentUser.toUpperCase()}`, 14, 30); doc.text(`Periodo: ${start.toLocaleDateString()} - ${end.toLocaleDateString()}`, 14, 36); let rows = filtered.map(item => { let data = new Date(item.inizio).toLocaleDateString(); let tipo = item.tipo; if(item.luogo) tipo += ` (${item.luogo})`; let ore = formattaOreMinuti(item.totale); let euro = item.importo ? `‚Ç¨ ${item.importo.toFixed(2)}` : "-"; let note = item.note || ""; return [data, tipo, ore, euro, note]; }); doc.autoTable({ startY: 45, head: [['Data', 'Attivit√†', 'Ore', 'Importo', 'Note']], body: rows, theme: 'grid', headStyles: { fillColor: [206, 56, 36], textColor: 255 }, styles: { fontSize: 9 } }); let totOre = filtered.reduce((acc, x) => acc + parseFloat(x.totale), 0); let totEuro = filtered.reduce((acc, x) => acc + (x.importo || 0), 0); let finalY = doc.lastAutoTable.finalY + 10; doc.setFontSize(12); doc.setFont("helvetica", "bold"); doc.text(`TOTALE ORE: ${formattaOreMinuti(totOre)}`, 14, finalY); doc.text(`TOTALE ESTIMATO: ‚Ç¨ ${totEuro.toFixed(2)}`, 14, finalY + 7); doc.setFontSize(8); doc.setFont("helvetica", "italic"); doc.setTextColor(100); let disclaimer = "NOTA AMMINISTRATIVA: Gli importi in euro riportati nel presente documento sono stime indicative, calcolate sulla base delle tariffe orarie lorde tabellari. Il valore effettivo della liquidazione in busta paga √® soggetto a variabili fiscali, previdenziali e amministrative (es. conguagli, addizionali regionali/comunali, detrazioni) non gestibili da questo software. Il presente prospetto non costituisce certificazione ufficiale."; let splitText = doc.splitTextToSize(disclaimer, 180); doc.text(splitText, 14, 280); doc.save(`Report_VVF_${startStr}_${endStr}.pdf`); }
        
        // Logica Standard (Time, Helpers, etc)
        function formattaOreMinuti(oreDecimali) { let minTot = Math.round(oreDecimali * 60); let h = Math.floor(minTot / 60); let m = minTot % 60; return `${h}h ${String(m).padStart(2,'0')}m`; }
        function mostraRisultatoBox(totale, soldi, rientro) { let html = `<div style="display:flex; justify-content:space-between; align-items:center;"><strong>TOTALE ORE</strong><span style="font-size:1.4em; font-weight:800; color:var(--tech-dark);">${formattaOreMinuti(totale)}</span></div><div style="display:flex; justify-content:space-between; align-items:center; margin-top:5px; border-top:1px dashed #ccc; padding-top:5px;"><strong>STIMA IMPORTO</strong><span style="font-size:1.6em; font-weight:800; color:var(--vvf-verde);">‚Ç¨ ${soldi.toFixed(2)}</span></div><div style="margin-top:10px; font-size:12px; color:#666;">SEGNA AL TURNO: <span class="badge bg-${rientro}">${rientro}</span></div>`; document.getElementById('risultato-box').innerHTML = html; document.getElementById('risultato-box').style.display = 'block'; document.getElementById('btn-vedi-dettaglio').classList.remove('hidden'); }
        function mostraDettaglioUltimo() { let note = document.getElementById('note').value; renderizzaDettagli(ultimoCalcoloDettagli, note); }
        function mostraDettaglioDaStorico(id) { let list = JSON.parse(localStorage.getItem(getHistoryKey()) || '[]'); let item = list.find(x => x.id === id); if(item) renderizzaDettagli({tipo: item.tipo, fasce: item.dettagli, soldi: item.importo, luogo: item.luogo, oreTot: item.totale}, item.note); }
        function renderizzaDettagli(data, note) { let html = ``; if (data.luogo) html += `<div style="background:var(--vvf-crema); padding:10px; border:1px solid var(--vvf-oro); margin-bottom:15px; font-weight:bold; color:var(--vvf-rosso); text-align:center;">üìç ${data.luogo}</div>`; html += `<table class="detail-table">`; if (data.fasce.mode === 'flat') { html += `<tr><td>TIPO SERVIZIO</td><td class="detail-val" style="color:var(--vvf-rosso)">${data.tipo.toUpperCase()}</td></tr><tr><td>TARIFFA ORARIA</td><td class="detail-val">‚Ç¨ ${data.fasce.rate.toFixed(2)}</td></tr><tr><td>ORE TOTALI</td><td class="detail-val">${formattaOreMinuti(data.oreTot)}</td></tr>`; } else { html += `<tr><td>QUALIFICA</td><td class="detail-val">${userRates.label || 'Standard'}</td></tr><tr><td>FERIALE (06-22)</td><td class="detail-val">${formattaOreMinuti(data.fasce.feriale)}</td></tr><tr><td>FEST/NOTTURNO</td><td class="detail-val">${formattaOreMinuti(data.fasce.mista)}</td></tr><tr><td>FESTIVO NOTTURNO</td><td class="detail-val">${formattaOreMinuti(data.fasce.festNotte)}</td></tr>`; } html += `<tr style="background:rgba(0,0,0,0.05); font-weight:bold;"><td>TOTALE STIMATO</td><td class="detail-val" style="color:var(--vvf-verde); font-size:1.4em;">‚Ç¨ ${data.soldi.toFixed(2)}</td></tr></table>`; if(note) html += `<div class="detail-notes"><strong>NOTE:</strong><br>${note}</div>`; document.getElementById('detail-content').innerHTML = html; document.getElementById('view-app').classList.add('hidden'); document.getElementById('view-detail').classList.remove('hidden'); }
        function chiudiDettaglio() { document.getElementById('view-detail').classList.add('hidden'); document.getElementById('view-app').classList.remove('hidden'); }
        function isPasquaOPasquetta(date) { const p = ["2025-04-20", "2026-04-05"]; const pq = ["2025-04-21", "2026-04-06"]; let iso = date.toISOString().split('T')[0]; return p.includes(iso) || pq.includes(iso); }
        function getTurno(d) { let diff = (d.getTime() - dataAncora.getTime()) / 3600000; return sequenzaTurni[((Math.floor(diff/12)%8)+8)%8]; }
        function getCategoriaOraria(dateObj) { let h = dateObj.getHours(); let d = dateObj.getDate(); let m = dateObj.getMonth() + 1; let keyDate = `${d}/${m}`; let dayOfWeek = dateObj.getDay(); let isNotte = (h < 6 || h >= 22); let isFesta = (dayOfWeek === 0 || superFestiviFissi.includes(keyDate) || isPasquaOPasquetta(dateObj)); if (isNotte && isFesta) return 'festNotte'; if (isFesta) return 'mista'; if (isNotte) return 'mista'; return 'feriale'; }
        function toggleRecovery() { document.getElementById('password-section').classList.toggle('hidden'); document.getElementById('recovery-section').classList.toggle('hidden'); }
        function resetLoginUI() { document.getElementById('password-section').classList.add('hidden'); document.getElementById('register-section').classList.add('hidden'); document.getElementById('recovery-section').classList.add('hidden'); document.getElementById('btn-login-action').innerText = "PROCEDI"; document.getElementById('error-text').style.display = 'none'; loginState = 'check'; }
        function logout() { localStorage.removeItem(LAST_USER_KEY); location.reload(); } // LOGOUT CLEARS REMEMBER ME
        function getHistoryKey() { return `vvf_history_${currentUser}`; }
        function salvaRecord(rec) { let k = getHistoryKey(); let l = JSON.parse(localStorage.getItem(k)||'[]'); l.unshift(rec); localStorage.setItem(k, JSON.stringify(l)); caricaStorico(); }
        function toggleVisto(id) { let k = getHistoryKey(); let l = JSON.parse(localStorage.getItem(k)||'[]'); let i = l.findIndex(x => x.id === id); if(i !== -1) { l[i].visto = !l[i].visto; localStorage.setItem(k, JSON.stringify(l)); caricaStorico(); } }
        function caricaStorico() { let l = JSON.parse(localStorage.getItem(getHistoryKey())||'[]'); let c = document.getElementById('lista-storico'); if(l.length===0) { c.innerHTML='<p style="text-align:center;font-size:11px;color:#999">NESSUN DATO</p>'; return; } let h = ''; l.forEach(i => { let d = new Date(i.inizio).toLocaleDateString('it-IT',{day:'numeric',month:'short'}).toUpperCase(); let imp = i.importo ? `‚Ç¨ ${i.importo.toFixed(2)}` : 'N/D'; let tipoDisplay = i.tipo.toUpperCase(); if (i.tipo === 'Vigilanza' && i.luogo) tipoDisplay += `<br><span style="font-size:0.9em; color:#555;">üìç ${i.luogo}</span>`; h += `<div class="history-item ${i.visto?'visto':''}"> <div class="history-header"> <span class="history-date">${d}</span> <div class="check-container" onclick="toggleVisto(${i.id})"><div class="check-box"></div>VERIFICATO</div> <span class="badge bg-${i.rientro}" style="transform:scale(0.8)">${i.rientro}</span> </div> <div class="history-sub" style="display:flex; justify-content:space-between; align-items:center;"> <span>${tipoDisplay}</span> <span style="font-weight:bold; color:var(--vvf-verde);">${imp}</span> </div> <div class="history-actions"> <button class="ghost" style="margin:0; padding:2px 8px;" onclick="mostraDettaglioDaStorico(${i.id})">INFO</button> <button class="btn-delete" onclick="eliminaRecord(${i.id})">ELIMINA</button> </div> </div>`; }); c.innerHTML = h; }
        function eliminaRecord(id) { if(confirm("Eliminare?")) { let k = getHistoryKey(); let l = JSON.parse(localStorage.getItem(k)||'[]'); localStorage.setItem(k, JSON.stringify(l.filter(x=>x.id!==id))); caricaStorico(); } }
        function resetStorico() { if(confirm("Reset totale?")) { localStorage.removeItem(getHistoryKey()); caricaStorico(); } }
        function aggiornaLiveUI() { let now = new Date(); let turno = getTurno(now); let opzioniData = { weekday: 'short', day: 'numeric', month: 'short', year: 'numeric' }; document.getElementById('data-live').innerText = now.toLocaleDateString('it-IT', opzioniData); let ore = String(now.getHours()).padStart(2, '0'); let min = String(now.getMinutes()).padStart(2, '0'); document.getElementById('orario-live').innerText = `${ore}:${min}`; document.getElementById('oggi-turno-badge').innerHTML = `<span class="badge bg-${turno}" style="font-size:1.4em; padding:5px 15px; border:2px solid var(--vvf-rosso); color:var(--vvf-rosso); background:transparent;">${turno}</span>`; }
        function impostaDateDefault() { let now = new Date(); now.setMinutes(now.getMinutes() - now.getTimezoneOffset()); document.getElementById('inizio').value = now.toISOString().slice(0,16); document.getElementById('fine').value = now.toISOString().slice(0,16); }
    </script>
</body>
</html>
