<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Turnario VVF Smart</title>
    <style>
        /* --- CONFIGURAZIONE COLORI VVF --- */
        :root {
            --vvf-red: #ce3824;
            --vvf-dark: #060611;
            --vvf-teal: #308e89;
            --vvf-gray: #bac9d0;
            --vvf-bg: #f4f7f9;
        }

        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            background-color: var(--vvf-bg); 
            margin: 0; 
            padding: 20px 15px; 
            color: var(--vvf-dark);
            -webkit-font-smoothing: antialiased;
        }
        
        /* CARD E LAYOUT */
        .card { 
            background: white; 
            padding: 25px 20px; 
            border-radius: 16px; 
            box-shadow: 0 4px 20px rgba(0,0,0,0.06); 
            margin-bottom: 25px; 
            border: 1px solid rgba(0,0,0,0.05); 
        }
        
        .header { text-align: center; margin-bottom: 20px; }
        .header h1 { color: var(--vvf-red); margin: 0; font-size: 26px; font-weight: 800; }
        .header p { color: var(--vvf-teal); font-size: 14px; margin-top: 5px; font-weight: 600; }

        /* INPUT STYLE */
        label { font-weight: 700; font-size: 13px; display: block; margin-top: 18px; color: var(--vvf-dark); text-transform: uppercase; letter-spacing: 0.5px; }
        
        input, select, textarea { 
            width: 100%; 
            padding: 14px; 
            margin-top: 8px; 
            border: 2px solid var(--vvf-gray); 
            border-radius: 10px; 
            font-size: 16px; 
            background: #fff;
            box-sizing: border-box; /* Fix padding issues */
            transition: border-color 0.3s;
        }
        input:focus, select:focus, textarea:focus { 
            outline: none; 
            border-color: var(--vvf-teal); 
        }
        
        /* BOTTONI */
        button { 
            background-color: var(--vvf-red); 
            color: white; 
            border: none; 
            padding: 18px; 
            width: 100%; 
            border-radius: 12px; 
            font-size: 16px; 
            font-weight: 800; 
            cursor: pointer; 
            margin-top: 25px; 
            box-shadow: 0 4px 10px rgba(206, 56, 36, 0.3);
        }
        button:active { transform: scale(0.98); }
        button.secondary { background-color: var(--vvf-teal); box-shadow: none; margin-top: 10px; }
        button.ghost { background-color: transparent; color: #666; border: 1px solid #ccc; box-shadow: none; margin-top: 10px; padding: 12px; font-size: 14px; }
        
        /* LOGIN FLOW */
        .login-msg { font-size: 14px; text-align: center; margin-bottom: 15px; color: #666; }
        .error-msg { color: #d32f2f; font-size: 13px; margin-top: 5px; font-weight: bold; display: none; }

        /* BADGES TURNI */
        .badge { 
            display: inline-flex; 
            align-items: center;
            justify-content: center;
            padding: 4px 12px; 
            border-radius: 6px; 
            color: white; 
            font-weight: 800; 
            font-size: 1em; 
            min-width: 35px; 
            text-align: center; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .bg-A { background-color: #d32f2f; } /* Rosso */
        .bg-B { background-color: #2e7d32; } /* Verde Scuro */
        .bg-C { background-color: #1565c0; } /* Blu */
        .bg-D { background-color: #fbc02d; color: #333; } /* Giallo */

        /* RISULTATI */
        .result-box { background-color: #e0f2f1; border-left: 5px solid var(--vvf-teal); padding: 15px; border-radius: 8px; margin-top: 20px; display: none; }
        
        /* STORICO */
        .history-item { 
            border-bottom: 1px solid #eee; 
            padding: 15px 0; 
            position: relative;
        }
        .history-date { font-weight: 800; color: var(--vvf-dark); font-size: 15px; }
        .history-sub { font-size: 13px; color: #666; margin-top: 4px; }
        .history-turn { position: absolute; top: 15px; right: 0; }
        .btn-delete { 
            background: none; border: none; color: #d32f2f; 
            padding: 0; margin: 5px 0 0 0; width: auto; 
            font-size: 12px; font-weight: 600; box-shadow: none; 
            text-decoration: underline; cursor: pointer;
        }

        .hidden { display: none !important; }
        
        /* INFO BANNER */
        .info-turno-box {
            background: white; 
            padding: 15px; 
            border-radius: 12px; 
            margin-top: 10px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.05); 
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            border-left: 4px solid var(--vvf-red);
        }
    </style>
</head>
<body>

    <!-- SCHERMATA LOGIN -->
    <div id="view-login">
        <div class="header" style="margin-top: 40px;">
            <h1>ðŸš’ VVF Mobile</h1>
            <p>Gestionale Turni & Straordinari</p>
        </div>

        <div class="card">
            <p class="login-msg" id="login-intro">Inserisci il tuo Nome Utente per iniziare</p>
            
            <label>Nome Utente</label>
            <input type="text" id="username" placeholder="Es. MarcoRossi" oninput="resetLoginUI()">
            
            <div id="password-section" class="hidden">
                <label>Password</label>
                <input type="password" id="password" placeholder="Inserisci password">
            </div>

            <div id="register-section" class="hidden">
                <p style="color: var(--vvf-teal); font-size: 13px; margin-top: 15px;">ðŸ‘‹ Benvenuto! Crea una password per il tuo nuovo account.</p>
                <label>Crea Password</label>
                <input type="password" id="new-password" placeholder="Scegli una password">
            </div>

            <p id="error-text" class="error-msg">Errore credenziali</p>

            <button id="btn-login-action" onclick="checkUser()">AVANTI</button>
        </div>
    </div>

    <!-- SCHERMATA APP -->
    <div id="view-app" class="hidden">
        <div class="header">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h1 style="font-size: 20px;">Registro AttivitÃ </h1>
                <span id="user-badge" style="background:#eee; padding:5px 10px; border-radius:20px; font-size:12px; font-weight:bold; color: #555;">User</span>
            </div>
            
            <div class="info-turno-box">
                <div>
                    <span style="font-size: 12px; color: #888; display:block;">ADESSO IN SERVIZIO</span>
                    <strong id="orario-live" style="font-size: 14px;">--:--</strong>
                </div>
                <div id="oggi-turno-badge">
                    ...
                </div>
            </div>
        </div>

        <div class="card">
            <label>Tipo AttivitÃ </label>
            <select id="tipo">
                <option value="Soccorso">ðŸ”¥ Straordinario SOCCORSO</option>
                <option value="Guida">ðŸš’ Ore di GUIDA</option>
                <option value="Boschivo">ðŸŒ² AIB / Boschivo</option>
            </select>

            <label>Inizio Servizio</label>
            <input type="datetime-local" id="inizio">

            <label>Fine Servizio</label>
            <input type="datetime-local" id="fine">

            <label>Note</label>
            <textarea id="note" rows="2" placeholder="Dettagli intervento..."></textarea>

            <button onclick="calcolaESalva()">REGISTRA E CALCOLA</button>

            <div id="risultato-box" class="result-box"></div>
        </div>

        <div class="card">
            <h3 style="color: var(--vvf-dark); margin-top:0;">Archivio Storico</h3>
            <div id="lista-storico"></div>
            <button class="ghost" onclick="resetStorico()">Svuota Storico</button>
        </div>

        <button class="ghost" onclick="logout()">Esci</button>
    </div>

    <script>
        // ===============================================
        //  1. MOTORE MATEMATICO TURNI (CORRETTO)
        // ===============================================
        
        // Sequenza ciclica: 
        // 1 Dic Giorno=C, 1 Dic Notte=B, 2 Dic Giorno=D, 2 Dic Notte=C...
        const sequenzaTurni = ['C', 'B', 'D', 'C', 'A', 'D', 'B', 'A']; 
        
        // ANCORA FISSA: 1 Dicembre 2024 (Data di calibrazione)
        // Usiamo un riferimento "Puro" a mezzanotte per contare i giorni
        const dataAncora = new Date(2024, 11, 1, 0, 0, 0); // 11 = Dicembre

        function getTurno(dataOggetto) {
            // Clona la data per non modificarla
            let d = new Date(dataOggetto);
            let ora = d.getHours();

            // LOGICA NOTTE (Cruciale per sincronizzazione):
            // Il turno notturno va dalle 20:00 alle 08:00.
            // Se sono le 04:00 del 2 Dicembre, siamo tecnicamente ancora nel turno
            // iniziato la sera del 1 Dicembre. Quindi per il calcolo, consideriamo "ieri".
            
            let isNotte = false;

            if (ora >= 20) {
                // E' sera/notte del giorno corrente
                isNotte = true;
            } else if (ora < 8) {
                // E' mattina presto, ma appartiene al turno notturno del giorno PRIMA
                isNotte = true;
                d.setDate(d.getDate() - 1); // Torno indietro di 1 giorno solare
            }

            // Calcolo giorni interi passati dall'ancora (1 Dic 2024)
            let start = new Date(2024, 11, 1, 0, 0, 0);
            let current = new Date(d.getFullYear(), d.getMonth(), d.getDate(), 0, 0, 0);
            
            let diffTime = current.getTime() - start.getTime();
            let diffDays = Math.round(diffTime / (1000 * 3600 * 24));

            // Ogni giorno ha 2 slot nella sequenza (Giorno, Notte)
            // Indice base = giorni * 2
            let indiceBase = diffDays * 2;
            
            // Se siamo nello slot notturno, avanziamo di 1
            if (isNotte) {
                indiceBase += 1;
            }

            // Calcolo modulo (gestisce anche date passate/negative)
            let indiceFinale = ((indiceBase % 8) + 8) % 8;
            
            return sequenzaTurni[indiceFinale];
        }

        // ===============================================
        //  2. SISTEMA DI LOGIN
        // ===============================================
        let dbUtenti = JSON.parse(localStorage.getItem('vvf_users_db') || '{}');
        let currentUser = null;
        let loginState = 'check';

        function checkUser() {
            let userField = document.getElementById('username');
            let user = userField.value.trim();
            let btn = document.getElementById('btn-login-action');
            let errorParams = document.getElementById('error-text');

            if(!user) return;

            if (loginState === 'check') {
                if (dbUtenti.hasOwnProperty(user)) {
                    document.getElementById('password-section').classList.remove('hidden');
                    document.getElementById('login-intro').innerText = "Bentornato! Inserisci la tua password.";
                    btn.innerText = "ACCEDI";
                    loginState = 'login';
                    userField.disabled = true;
                } else {
                    document.getElementById('register-section').classList.remove('hidden');
                    document.getElementById('login-intro').innerText = "Creazione nuovo profilo.";
                    btn.innerText = "REGISTRATI E ENTRA";
                    loginState = 'register';
                    userField.disabled = true;
                }
            } else if (loginState === 'login') {
                let pass = document.getElementById('password').value;
                if (dbUtenti[user] === pass) {
                    avviaApp(user);
                } else {
                    errorParams.style.display = 'block';
                    errorParams.innerText = "Password errata!";
                }
            } else if (loginState === 'register') {
                let newPass = document.getElementById('new-password').value;
                if (newPass.length > 0) {
                    dbUtenti[user] = newPass;
                    localStorage.setItem('vvf_users_db', JSON.stringify(dbUtenti));
                    avviaApp(user);
                } else {
                    alert("Scegli una password!");
                }
            }
        }

        function resetLoginUI() {
            document.getElementById('password-section').classList.add('hidden');
            document.getElementById('register-section').classList.add('hidden');
            document.getElementById('btn-login-action').innerText = "AVANTI";
            document.getElementById('error-text').style.display = 'none';
            loginState = 'check';
        }

        function avviaApp(user) {
            currentUser = user;
            document.getElementById('view-login').classList.add('hidden');
            document.getElementById('view-app').classList.remove('hidden');
            document.getElementById('user-badge').innerText = user;
            
            impostaDateDefault();
            aggiornaLiveUI();
            setInterval(aggiornaLiveUI, 60000); // Aggiorna ogni minuto
            caricaStorico();
        }

        function logout() {
            location.reload();
        }

        // ===============================================
        //  3. LOGICA APP E CALCOLO
        // ===============================================

        function aggiornaLiveUI() {
            let now = new Date();
            let turno = getTurno(now);
            
            // Format orario
            let ore = String(now.getHours()).padStart(2, '0');
            let min = String(now.getMinutes()).padStart(2, '0');
            document.getElementById('orario-live').innerText = `${ore}:${min}`;

            // Badge Turno Attuale
            document.getElementById('oggi-turno-badge').innerHTML = 
                `<span class="badge bg-${turno}" style="font-size:1.4em; padding:8px 16px;">TURNO ${turno}</span>`;
        }

        function impostaDateDefault() {
            let now = new Date();
            now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            let iso = now.toISOString().slice(0,16);
            document.getElementById('inizio').value = iso;
            document.getElementById('fine').value = iso;
        }

        function calcolaESalva() {
            let inizio = new Date(document.getElementById('inizio').value);
            let fine = new Date(document.getElementById('fine').value);
            let tipo = document.getElementById('tipo').value;
            let note = document.getElementById('note').value;

            if (fine <= inizio) { alert("Attenzione: La fine deve essere dopo l'inizio."); return; }

            let segmenti = [];
            let cursore = new Date(inizio);
            let totaleOre = 0;

            // Algoritmo di scansione temporale
            while (cursore < fine) {
                let prossimoCambio = new Date(cursore);
                let ora = cursore.getHours();

                // Logica Cambio Turno: 08:00 e 20:00
                if (ora >= 8 && ora < 20) {
                    prossimoCambio.setHours(20, 0, 0, 0);
                } else {
                    if (ora >= 20) prossimoCambio.setDate(prossimoCambio.getDate() + 1);
                    prossimoCambio.setHours(8, 0, 0, 0);
                }

                let fineSegmento = (prossimoCambio < fine) ? prossimoCambio : fine;
                let durataMs = fineSegmento - cursore;
                let durataOre = durataMs / (1000 * 60 * 60);
                
                // Usiamo un punto medio del segmento per determinare il turno in modo sicuro
                let puntoMedio = new Date(cursore.getTime() + (durataMs / 2));
                let turnoAttivo = getTurno(puntoMedio);

                segmenti.push({
                    turno: turnoAttivo,
                    ore: durataOre
                });

                totaleOre += durataOre;
                cursore = fineSegmento;
            }

            // Calcolo Turno di Rientro (l'ultimo istante di lavoro)
            let dataUltimoIstante = new Date(fine.getTime() - 1000);
            let turnoRientro = getTurno(dataUltimoIstante);

            // 1. Mostra risultato immediato
            let htmlRes = `<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                            <strong>TOTALE</strong> 
                            <span style="font-size:1.2em; font-weight:800; color:var(--vvf-red);">${totaleOre.toFixed(2)} ore</span>
                           </div>`;
            
            segmenti.forEach(s => {
                htmlRes += `<div style="margin-bottom:4px; font-size:14px;">
                                â€¢ ${s.ore.toFixed(2)}h su <span class="badge bg-${s.turno}" style="font-size:0.8em; padding:2px 6px;">${s.turno}</span>
                            </div>`;
            });
            
            htmlRes += `<div style="margin-top:10px; border-top:1px solid #ccc; padding-top:10px; font-size:13px; color:#555;">
                        ðŸ’° Richiedi pagamento nel turno: <span class="badge bg-${turnoRientro}">${turnoRientro}</span></div>`;
            
            let box = document.getElementById('risultato-box');
            box.innerHTML = htmlRes;
            box.style.display = 'block';

            // 2. Salva nello storico
            let record = {
                id: Date.now(),
                tipo: tipo,
                inizio: inizio.toISOString(),
                fine: fine.toISOString(),
                totale: totaleOre.toFixed(2),
                rientro: turnoRientro,
                segmenti: segmenti,
                note: note
            };
            salvaRecord(record);
        }

        // ===============================================
        //  4. GESTIONE STORICO (PERSISTENZA)
        // ===============================================

        function getHistoryKey() {
            return `vvf_history_${currentUser}`;
        }

        function salvaRecord(record) {
            let key = getHistoryKey();
            let list = JSON.parse(localStorage.getItem(key) || '[]');
            list.unshift(record);
            localStorage.setItem(key, JSON.stringify(list));
            caricaStorico();
        }

        function caricaStorico() {
            let list = JSON.parse(localStorage.getItem(getHistoryKey()) || '[]');
            let container = document.getElementById('lista-storico');
            
            if (list.length === 0) {
                container.innerHTML = '<p style="text-align:center; font-size:13px; color:#999;">Nessuna registrazione.</p>';
                return;
            }

            let html = '';
            list.forEach(item => {
                let dIniz = new Date(item.inizio);
                let dFin = new Date(item.fine);
                
                let dataStr = dIniz.toLocaleDateString('it-IT', {day:'numeric', month:'short'});
                let oraStr = `${dIniz.getHours()}:${String(dIniz.getMinutes()).padStart(2,'0')} - ${dFin.getHours()}:${String(dFin.getMinutes()).padStart(2,'0')}`;

                let dettagliHtml = item.segmenti.map(s => `<b>${s.turno}</b>`).join('+');

                html += `
                <div class="history-item">
                    <div class="history-date">${dataStr} <span style="font-weight:normal; color:#666;">| ${oraStr}</span></div>
                    <div class="history-sub">
                        <strong style="color:var(--vvf-teal);">${item.tipo}</strong>: ${item.totale}h su [${dettagliHtml}]<br>
                        ${item.note ? `<em>Note: ${item.note}</em>` : ''}
                    </div>
                    <div class="history-turn">
                        <span class="badge bg-${item.rientro}">${item.rientro}</span>
                    </div>
                    <button class="btn-delete" onclick="eliminaRecord(${item.id})">Elimina</button>
                </div>`;
            });
            container.innerHTML = html;
        }

        function eliminaRecord(id) {
            if(!confirm("Eliminare questa registrazione?")) return;
            let key = getHistoryKey();
            let list = JSON.parse(localStorage.getItem(key) || '[]');
            let newList = list.filter(x => x.id !== id);
            localStorage.setItem(key, JSON.stringify(newList));
            caricaStorico();
        }

        function resetStorico() {
            if(confirm("Sei sicuro di voler cancellare tutto lo storico?")) {
                localStorage.removeItem(getHistoryKey());
                caricaStorico();
            }
        }
    </script>
</body>
</html>
