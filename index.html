<script>
        // ===============================================
        //  1. CONFIGURAZIONE MATEMATICA TURNI (CORRETTA AL 100%)
        // ===============================================
        
        // Sequenza ciclica di 8 turni (12 ore ciascuno)
        // Corrispondenza: Giorno C -> Notte B -> Giorno D -> Notte C -> Giorno A -> Notte D -> Giorno B -> Notte A
        const sequenzaTurni = ['C', 'B', 'D', 'C', 'A', 'D', 'B', 'A'];
        
        // PUNTO ZERO ASSOLUTO: 1 Dicembre 2025 ore 08:00 = INIZIO TURNO C
        // Nota: new Date(Anno, Mese-1, Giorno, Ore). 11 = Dicembre.
        const dataAncora = new Date(2025, 11, 1, 8, 0, 0); 

        function getTurno(dataOggetto) {
            // Calcola la differenza in millisecondi dall'ancora (1 Dic 2025)
            let diffMs = dataOggetto.getTime() - dataAncora.getTime();
            
            // Convertiamo in ore
            let oreDiff = diffMs / (1000 * 60 * 60);
            
            // Ogni turno dura 12 ore esatte
            // Math.floor gestisce correttamente i numeri negativi se guardiamo date passate
            let blocchiPassati = Math.floor(oreDiff / 12);
            
            // Calcolo indice ciclico (operatore modulo % 8)
            // ((n % 8) + 8) % 8 serve a gestire correttamente i numeri negativi (date prima del 1 dic)
            let indice = ((blocchiPassati % 8) + 8) % 8;
            
            return sequenzaTurni[indice];
        }

        // ===============================================
        //  2. SISTEMA DI LOGIN "INTELLIGENTE"
        // ===============================================
        let dbUtenti = JSON.parse(localStorage.getItem('vvf_users_db') || '{}');
        let currentUser = null;
        let loginState = 'check'; // check, login, register

        function checkUser() {
            let userField = document.getElementById('username');
            let user = userField.value.trim();
            let btn = document.getElementById('btn-login-action');
            let errorParams = document.getElementById('error-text');

            if(!user) return;

            if (loginState === 'check') {
                if (dbUtenti.hasOwnProperty(user)) {
                    document.getElementById('password-section').classList.remove('hidden');
                    document.getElementById('login-intro').innerText = "Bentornato! Inserisci la tua password.";
                    btn.innerText = "ACCEDI";
                    loginState = 'login';
                    userField.disabled = true; 
                } else {
                    document.getElementById('register-section').classList.remove('hidden');
                    document.getElementById('login-intro').innerText = "Creazione nuovo profilo.";
                    btn.innerText = "REGISTRATI E ENTRA";
                    loginState = 'register';
                    userField.disabled = true;
                }
            } else if (loginState === 'login') {
                let pass = document.getElementById('password').value;
                if (dbUtenti[user] === pass) {
                    avviaApp(user);
                } else {
                    errorParams.style.display = 'block';
                    errorParams.innerText = "Password errata!";
                }
            } else if (loginState === 'register') {
                let newPass = document.getElementById('new-password').value;
                if (newPass.length > 0) {
                    dbUtenti[user] = newPass;
                    localStorage.setItem('vvf_users_db', JSON.stringify(dbUtenti));
                    avviaApp(user);
                } else {
                    alert("Scegli una password!");
                }
            }
        }

        function resetLoginUI() {
            document.getElementById('password-section').classList.add('hidden');
            document.getElementById('register-section').classList.add('hidden');
            document.getElementById('btn-login-action').innerText = "AVANTI";
            document.getElementById('error-text').style.display = 'none';
            loginState = 'check';
        }

        function avviaApp(user) {
            currentUser = user;
            document.getElementById('view-login').classList.add('hidden');
            document.getElementById('view-app').classList.remove('hidden');
            document.getElementById('user-badge').innerText = user;
            
            impostaDateDefault();
            aggiornaTurnoOggi();
            caricaStorico();
            
            // Aggiorna ogni minuto per cambiare turno in real-time se l'app resta aperta
            setInterval(aggiornaTurnoOggi, 60000);
        }

        function logout() {
            location.reload();
        }

        // ===============================================
        //  3. LOGICA APP E CALCOLO
        // ===============================================

        function aggiornaTurnoOggi() {
            let now = new Date();
            let turno = getTurno(now);
            
            document.getElementById('oggi-turno-badge').innerHTML = 
                `<span class="badge bg-${turno}" style="font-size:1.2em;">TURNO ${turno}</span>`;
        }

        function impostaDateDefault() {
            let now = new Date();
            now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            let iso = now.toISOString().slice(0,16);
            document.getElementById('inizio').value = iso;
            document.getElementById('fine').value = iso;
        }

        function calcolaESalva() {
            let inizio = new Date(document.getElementById('inizio').value);
            let fine = new Date(document.getElementById('fine').value);
            let tipo = document.getElementById('tipo').value;
            let note = document.getElementById('note').value;

            if (fine <= inizio) { alert("Attenzione: La fine deve essere dopo l'inizio."); return; }

            let segmenti = [];
            let cursore = new Date(inizio);
            let totaleOre = 0;

            while (cursore < fine) {
                let prossimoCambio = new Date(cursore);
                let ora = cursore.getHours();

                // Cambio turno alle 08:00 e alle 20:00
                if (ora >= 8 && ora < 20) {
                    prossimoCambio.setHours(20, 0, 0, 0); // Fine turno diurno
                } else {
                    if (ora >= 20) prossimoCambio.setDate(prossimoCambio.getDate() + 1);
                    prossimoCambio.setHours(8, 0, 0, 0); // Fine turno notturno
                }

                let fineSegmento = (prossimoCambio < fine) ? prossimoCambio : fine;
                let durataMs = fineSegmento - cursore;
                let durataOre = durataMs / (1000 * 60 * 60);
                
                let turnoAttivo = getTurno(cursore);

                segmenti.push({
                    turno: turnoAttivo,
                    ore: durataOre
                });

                totaleOre += durataOre;
                cursore = fineSegmento;
            }

            let dataUltimoIstante = new Date(fine.getTime() - 1000);
            let turnoRientro = getTurno(dataUltimoIstante);

            let htmlRes = `<strong>Totale: ${totaleOre.toFixed(2)} ore</strong><br>`;
            segmenti.forEach(s => {
                htmlRes += `â€¢ ${s.ore.toFixed(2)}h su <span class="badge bg-${s.turno}">${s.turno}</span><br>`;
            });
            htmlRes += `<div style="margin-top:10px; border-top:1px solid #ccc; padding-top:5px;">
                        ðŸ’° Richiedi pagamento nel turno: <span class="badge bg-${turnoRientro}">${turnoRientro}</span></div>`;
            
            let box = document.getElementById('risultato-box');
            box.innerHTML = htmlRes;
            box.style.display = 'block';

            let record = {
                id: Date.now(),
                tipo: tipo,
                inizio: inizio.toISOString(),
                fine: fine.toISOString(),
                totale: totaleOre.toFixed(2),
                rientro: turnoRientro,
                segmenti: segmenti,
                note: note
            };
            salvaRecord(record);
        }

        // ===============================================
        //  4. GESTIONE STORICO
        // ===============================================

        function getHistoryKey() {
            return `vvf_history_${currentUser}`;
        }

        function salvaRecord(record) {
            let key = getHistoryKey();
            let list = JSON.parse(localStorage.getItem(key) || '[]');
            list.unshift(record);
            localStorage.setItem(key, JSON.stringify(list));
            caricaStorico();
        }

        function caricaStorico() {
            let list = JSON.parse(localStorage.getItem(getHistoryKey()) || '[]');
            let container = document.getElementById('lista-storico');
            
            if (list.length === 0) {
                container.innerHTML = '<p style="text-align:center; font-size:13px; color:#999;">Nessuna registrazione.</p>';
                return;
            }

            let html = '';
            list.forEach(item => {
                let dIniz = new Date(item.inizio);
                let dFin = new Date(item.fine);
                
                let dataStr = dIniz.toLocaleDateString('it-IT', {day:'numeric', month:'short'});
                let oraStr = `${dIniz.getHours()}:${String(dIniz.getMinutes()).padStart(2,'0')} - ${dFin.getHours()}:${String(dFin.getMinutes()).padStart(2,'0')}`;

                let dettagliHtml = item.segmenti.map(s => `${s.ore.toFixed(1)}h(${s.turno})`).join('+');

                html += `
                <div class="history-item">
                    <div class="history-date">${dataStr} <span style="font-weight:normal; color:#666;">| ${oraStr}</span></div>
                    <div class="history-sub">
                        <strong>${item.tipo}</strong>: ${item.totale}h [${dettagliHtml}]<br>
                        ${item.note ? `<em>Note: ${item.note}</em>` : ''}
                    </div>
                    <div class="history-turn">
                        <span class="badge bg-${item.rientro}">${item.rientro}</span>
                    </div>
                    <button class="btn-delete" onclick="eliminaRecord(${item.id})">Elimina</button>
                </div>`;
            });
            container.innerHTML = html;
        }

        function eliminaRecord(id) {
            if(!confirm("Eliminare questa registrazione?")) return;
            let key = getHistoryKey();
            let list = JSON.parse(localStorage.getItem(key) || '[]');
            let newList = list.filter(x => x.id !== id);
            localStorage.setItem(key, JSON.stringify(newList));
            caricaStorico();
        }

        function resetStorico() {
            if(confirm("Sei sicuro di voler cancellare tutto lo storico?")) {
                localStorage.removeItem(getHistoryKey());
                caricaStorico();
            }
        }
    </script>
