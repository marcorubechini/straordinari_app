<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Turnario VVF Pro</title>
    <style>
        /* --- CONFIGURAZIONE COLORI --- */
        :root {
            --vvf-red: #ce3824;
            --vvf-dark: #060611;
            --vvf-teal: #308e89;
            --vvf-gray: #bac9d0;
            --vvf-bg: #f4f7f9;
        }

        body { font-family: -apple-system, sans-serif; background-color: var(--vvf-bg); margin: 0; padding: 20px 15px; color: var(--vvf-dark); }
        
        /* LAYOUT */
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 20px; border: 1px solid rgba(0,0,0,0.05); }
        .hidden { display: none; }
        
        /* TYPOGRAPHY */
        h1 { color: var(--vvf-red); margin: 0 0 5px 0; font-size: 22px; text-align: center; }
        h2 { font-size: 18px; margin-bottom: 15px; color: var(--vvf-teal); border-bottom: 2px solid var(--vvf-gray); padding-bottom: 5px; }
        label { font-weight: 600; font-size: 13px; display: block; margin-top: 15px; color: var(--vvf-dark); }
        
        /* INPUTS & BUTTONS */
        input, select, textarea { width: 100%; padding: 12px; margin-top: 5px; border: 1px solid var(--vvf-gray); border-radius: 8px; font-size: 16px; background: white; }
        input:focus, textarea:focus { outline: none; border-color: var(--vvf-teal); box-shadow: 0 0 0 3px rgba(48, 142, 137, 0.1); }
        
        button { background-color: var(--vvf-red); color: white; border: none; padding: 15px; width: 100%; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 20px; }
        button:active { transform: scale(0.98); background-color: #b32b1b; }
        button.secondary { background-color: var(--vvf-teal); margin-top: 10px; }
        button.delete { background-color: white; color: #d32f2f; border: 1px solid #d32f2f; padding: 5px 10px; margin-top: 5px; font-size: 12px; width: auto; }

        /* RISULTATI E STORICO */
        .result-box { background-color: #e0f2f1; border-left: 5px solid var(--vvf-teal); padding: 15px; border-radius: 8px; margin-top: 20px; }
        .history-item { border-bottom: 1px solid #eee; padding: 15px 0; }
        .history-item:last-child { border-bottom: none; }
        .history-date { font-weight: bold; font-size: 14px; color: var(--vvf-dark); }
        .history-details { font-size: 13px; color: #555; margin-top: 5px; }
        
        /* BADGES */
        .badge { padding: 3px 8px; border-radius: 4px; color: white; font-weight: bold; font-size: 0.85em; margin-left: 5px; }
        .bg-A { background-color: #d32f2f; }
        .bg-B { background-color: #388e3c; }
        .bg-C { background-color: #1976d2; }
        .bg-D { background-color: #fbc02d; color: black; }

        /* HEADER INFO */
        .info-bar { text-align: center; margin-bottom: 20px; font-size: 14px; font-weight: 500; color: #555; }
    </style>
</head>
<body>

    <div id="view-login" class="card">
        <h1>üîê VVF Accesso</h1>
        <p style="text-align:center; font-size:13px; color:#666;">Se √® la prima volta, la password verr√† creata ora.</p>
        
        <label>Nome Utente</label>
        <input type="text" id="login-user" placeholder="Es. MarioRossi">
        
        <label>Password</label>
        <input type="password" id="login-pass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
        
        <button onclick="gestisciLogin()">ACCEDI / REGISTRATI</button>
        <div id="login-error" style="color:red; text-align:center; margin-top:10px; font-size:13px;"></div>
    </div>

    <div id="view-app" class="hidden">
        <div class="info-bar">
            Ciao <span id="user-display" style="font-weight:bold; color:var(--vvf-red)"></span>! üëã<br>
            Oggi √® Turno: <span id="oggi-turno-badge">...</span>
        </div>

        <div class="card">
            <h2>üìù Nuova Registrazione</h2>
            
            <label>Attivit√†</label>
            <select id="tipo">
                <option value="Soccorso">Straordinario SOCCORSO</option>
                <option value="Guida">Ore di GUIDA</option>
            </select>

            <label>Inizio</label>
            <input type="datetime-local" id="inizio">

            <label>Fine</label>
            <input type="datetime-local" id="fine">

            <label>Note</label>
            <textarea id="note" rows="2" placeholder="Dettagli..."></textarea>

            <button onclick="calcolaESalva()">CALCOLA E SALVA</button>
            
            <div id="risultato-immediato" class="hidden result-box"></div>
        </div>

        <div class="card">
            <h2>üìÇ Storico Salvato</h2>
            <div id="lista-storico">
                <p style="text-align:center; color:#999;">Nessuna registrazione trovata.</p>
            </div>
            <button class="secondary" onclick="resetStorico()" style="background:#666;">CANCELLA TUTTO STORICO</button>
        </div>
        
        <button onclick="logout()" style="background:white; color:#333; border:1px solid #ccc; margin-top:30px;">Esci</button>
    </div>

    <script>
        // --- 1. CONFIGURAZIONE TURNI (Logica corretta al 100%) ---
        // Sequenza: C(G), B(N), D(G), C(N), A(G), D(N), B(G), A(N)
        // Ancora: 1 Dicembre 2024 ore 08:00 = INIZIO TURNO C
        const sequenzaTurni = ['C', 'B', 'D', 'C', 'A', 'D', 'B', 'A'];
        const dataAncora = new Date('2024-12-01T08:00:00').getTime(); 

        function getTurno(dateObj) {
            let msPerTurno = 12 * 60 * 60 * 1000; // 12 ore in millisecondi
            let diff = dateObj.getTime() - dataAncora;
            let turniPassati = Math.floor(diff / msPerTurno);
            
            // Modulo per gestire l'array circolare (anche date passate)
            let indice = ((turniPassati % 8) + 8) % 8;
            return sequenzaTurni[indice];
        }

        // --- 2. GESTIONE UTENTI (LocalStorage) ---
        let currentUser = null;

        function gestisciLogin() {
            let user = document.getElementById('login-user').value.trim();
            let pass = document.getElementById('login-pass').value.trim();
            let msg = document.getElementById('login-error');

            if (!user || !pass) {
                msg.innerText = "Inserisci utente e password.";
                return;
            }

            // Recupera utenti salvati
            let dbUtenti = JSON.parse(localStorage.getItem('vvf_users') || '{}');

            if (dbUtenti[user]) {
                // Utente esiste -> Verifica Password
                if (dbUtenti[user] === pass) {
                    entraInApp(user);
                } else {
                    msg.innerText = "Password errata!";
                }
            } else {
                // Utente nuovo -> Registra
                if(confirm("Utente non trovato. Vuoi creare un nuovo account con questa password?")) {
                    dbUtenti[user] = pass;
                    localStorage.setItem('vvf_users', JSON.stringify(dbUtenti));
                    entraInApp(user);
                }
            }
        }

        function entraInApp(username) {
            currentUser = username;
            document.getElementById('user-display').innerText = username;
            document.getElementById('view-login').classList.add('hidden');
            document.getElementById('view-app').classList.remove('hidden');
            
            // Imposta orari default e mostra turno oggi
            impostaDateDefault();
            mostraTurnoOdierno();
            caricaStorico();
        }

        function logout() {
            location.reload(); // Ricarica la pagina
        }

        // --- 3. CALCOLO E SALVATAGGIO ---
        function mostraTurnoOdierno() {
            let now = new Date();
            let t = getTurno(now);
            document.getElementById('oggi-turno-badge').innerHTML = `<span class="badge bg-${t}">${t}</span>`;
        }

        function impostaDateDefault() {
            let now = new Date();
            now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            document.getElementById('inizio').value = now.toISOString().slice(0,16);
            document.getElementById('fine').value = now.toISOString().slice(0,16);
        }

        function calcolaESalva() {
            let inizioInput = document.getElementById('inizio').value;
            let fineInput = document.getElementById('fine').value;
            let inizio = new Date(inizioInput);
            let fine = new Date(fineInput);
            let tipo = document.getElementById('tipo').value;
            let note = document.getElementById('note').value;

            if (fine <= inizio) { alert("La fine deve essere dopo l'inizio!"); return; }

            let dettaglioTurni = [];
            let cursore = new Date(inizio);
            let oreTotali = 0;

            // Logica scavallamento turno
            while (cursore < fine) {
                let prossimoCambio = new Date(cursore);
                let h = cursore.getHours();
                
                // I cambi sono alle 8:00 e alle 20:00
                if (h >= 8 && h < 20) {
                    prossimoCambio.setHours(20, 0, 0, 0);
                } else {
                    if (h >= 20) prossimoCambio.setDate(prossimoCambio.getDate() + 1);
                    prossimoCambio.setHours(8, 0, 0, 0);
                }

                let fineSegmento = (prossimoCambio < fine) ? prossimoCambio : fine;
                let oreSeg = (fineSegmento - cursore) / (36e5); // 36e5 = 1000*60*60
                let turnoSeg = getTurno(cursore);

                dettaglioTurni.push({ turno: turnoSeg, ore: oreSeg });
                oreTotali += oreSeg;
                cursore = fineSegmento;
            }

            let turnoRichiesta = getTurno(new Date(fine.getTime() - 1000));

            // Crea oggetto salvataggio
            let entry = {
                id: Date.now(),
                data: new Date().toLocaleDateString(),
                tipo: tipo,
                inizio: inizioInput,
                fine: fineInput,
                oreTot: oreTotali.toFixed(2),
                dettagli: dettaglioTurni,
                turnoRientro: turnoRichiesta,
                note: note
            };

            salvaNelloStorico(entry);
            mostraRisultatoImmediato(entry);
            caricaStorico(); // Aggiorna la lista
        }

        function mostraRisultatoImmediato(data) {
            let box = document.getElementById('risultato-immediato');
            let html = `<strong>‚úÖ Registrato! Totale: ${data.oreTot}h</strong><br>`;
            data.dettagli.forEach(d => {
                html += `‚Ä¢ ${d.ore.toFixed(2)}h su Turno <span class="badge bg-${d.turno}">${d.turno}</span><br>`;
            });
            html += `<br>üí∞ Richiedi su: <span class="badge bg-${data.turnoRientro}">${data.turnoRientro}</span>`;
            
            box.innerHTML = html;
            box.classList.remove('hidden');
        }

        // --- 4. GESTIONE STORICO (Database locale) ---
        function salvaNelloStorico(obj) {
            let key = `vvf_history_${currentUser}`;
            let history = JSON.parse(localStorage.getItem(key) || '[]');
            history.unshift(obj); // Aggiungi in cima
            localStorage.setItem(key, JSON.stringify(history));
        }

        function caricaStorico() {
            let key = `vvf_history_${currentUser}`;
            let history = JSON.parse(localStorage.getItem(key) || '[]');
            let container = document.getElementById('lista-storico');
            
            if (history.length === 0) {
                container.innerHTML = '<p style="text-align:center; color:#999;">Nessun dato salvato.</p>';
                return;
            }

            let html = '';
            history.forEach(item => {
                // Formatta data leggibile
                let dInizio = new Date(item.inizio).toLocaleString([], {day:'2-digit', month:'2-digit', hour:'2-digit', minute:'2-digit'});
                let dFine = new Date(item.fine).toLocaleString([], {hour:'2-digit', minute:'2-digit'});

                // Crea stringa dettagli turni
                let strTurni = item.dettagli.map(d => `${d.ore.toFixed(1)}h(${d.turno})`).join(' + ');

                html += `
                <div class="history-item">
                    <div class="history-date">
                        ${dInizio} ‚ûî ${dFine} | <strong>${item.tipo}</strong>
                    </div>
                    <div class="history-details">
                        Totale: <strong>${item.oreTot}h</strong> [${strTurni}]<br>
                        Richiesta su Turno: <span class="badge bg-${item.turnoRientro}">${item.turnoRientro}</span>
                        ${item.note ? `<br><em>Note: ${item.note}</em>` : ''}
                    </div>
                    <button class="delete" onclick="eliminaEntry(${item.id})">Elimina</button>
                </div>`;
            });
            container.innerHTML = html;
        }

        function eliminaEntry(id) {
            if(!confirm("Eliminare questa voce?")) return;
            let key = `vvf_history_${currentUser}`;
            let history = JSON.parse(localStorage.getItem(key) || '[]');
            let newHistory = history.filter(item => item.id !== id);
            localStorage.setItem(key, JSON.stringify(newHistory));
            caricaStorico();
        }

        function resetStorico() {
            if(confirm("Sei sicuro di voler cancellare TUTTO lo storico? Non si pu√≤ annullare.")) {
                localStorage.removeItem(`vvf_history_${currentUser}`);
                caricaStorico();
            }
        }
    </script>
</body>
</html>
