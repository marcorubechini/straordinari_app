<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>VVF Smart - Turnario & Ore</title>
    
    <!-- FONT EXO 2 (GOOGLE FONTS) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Exo+2:ital,wght@0,300;0,400;0,600;0,800;1,400&display=swap" rel="stylesheet">

    <style>
        /* --- CONFIGURAZIONE COLORI & FONT (PALETTE UFFICIALE) --- */
        :root {
            /* Palette Colori Specificata */
            --vvf-rosso-scuro: #A60000;   /* Rosso scuro */
            --vvf-rosso: #F50000;         /* Rosso vivo */
            --vvf-arancio: #FF5003;       /* Arancio */
            --vvf-giallo-oro: #FFC600;    /* Giallo oro */
            --vvf-giallo-chiaro: #FFF5C2; /* Giallo chiaro */
            
            /* Colori di supporto e interfaccia */
            --vvf-dark: #1a1a2e;
            --vvf-gray: #bac9d0;
            --vvf-bg: #f0f2f5;
        }

        body { 
            font-family: 'Exo 2', sans-serif;
            background-color: var(--vvf-bg); 
            margin: 0; 
            padding: 20px 15px; 
            color: var(--vvf-dark);
            -webkit-font-smoothing: antialiased;
        }
        
        /* CARD E LAYOUT */
        .card { 
            background: white; 
            padding: 25px 20px; 
            border-radius: 16px; 
            box-shadow: 0 4px 20px rgba(0,0,0,0.06); 
            margin-bottom: 25px; 
            border: 1px solid rgba(0,0,0,0.05); 
        }
        
        .header { text-align: center; margin-bottom: 25px; position: relative; }
        
        /* LOGO STYLE */
        .logo-container {
            width: 140px; /* Allargato leggermente per ospitare il disegno orizzontale */
            height: 100px;
            margin: 0 auto 20px auto;
            display: flex;
            align-items: center;
            justify-content: center;
            background: transparent;
        }
        
        .logo-svg {
            width: 100%;
            height: 100%;
        }

        /* Titolo principale in Rosso Vivo */
        .header h1 { color: var(--vvf-rosso); margin: 0; font-size: 28px; font-weight: 800; text-transform: uppercase; letter-spacing: 1px; }
        /* Sottotitolo in Arancio */
        .header p { color: var(--vvf-arancio); font-size: 14px; margin-top: 5px; font-weight: 600; }

        /* INPUT STYLE */
        label { font-weight: 700; font-size: 13px; display: block; margin-top: 18px; color: var(--vvf-dark); text-transform: uppercase; letter-spacing: 0.5px; }
        
        input, select, textarea { 
            width: 100%; 
            padding: 14px; 
            margin-top: 8px; 
            border: 2px solid var(--vvf-gray); 
            border-radius: 10px; 
            font-size: 16px; 
            font-family: 'Exo 2', sans-serif;
            background: #fff;
            box-sizing: border-box;
            transition: border-color 0.3s;
        }
        input:focus, select:focus, textarea:focus { 
            outline: none; 
            /* Focus con Arancio */
            border-color: var(--vvf-arancio); 
        }
        
        /* BOTTONI */
        button { 
            /* Sfondo bottone primario Rosso Vivo */
            background-color: var(--vvf-rosso); 
            color: white; 
            border: none; 
            padding: 16px; 
            width: 100%; 
            border-radius: 12px; 
            font-size: 16px; 
            font-weight: 700; 
            cursor: pointer; 
            margin-top: 20px; 
            box-shadow: 0 4px 10px rgba(245, 0, 0, 0.3); /* Ombra rossa */
            text-transform: uppercase;
        }
        button:active { transform: scale(0.98); }
        /* Bottone secondario Arancio */
        button.secondary { background-color: var(--vvf-arancio); box-shadow: none; margin-top: 10px; }
        button.ghost { background-color: transparent; color: #666; border: 1px solid #ccc; box-shadow: none; margin-top: 10px; padding: 12px; font-size: 14px; text-transform: none; }
        
        /* UI ELEMENTI */
        .login-msg { font-size: 14px; text-align: center; margin-bottom: 15px; color: #666; }
        .error-msg { color: var(--vvf-rosso); font-size: 13px; margin-top: 5px; font-weight: bold; display: none; }

        /* BADGES TURNI - Utilizzano la palette */
        .badge { 
            display: inline-flex; 
            align-items: center;
            justify-content: center;
            padding: 4px 12px; 
            border-radius: 6px; 
            color: white; 
            font-weight: 800; 
            font-size: 1em; 
            min-width: 35px; 
            text-align: center; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        /* Assegnazione colori specifici della palette ai turni */
        .bg-A { background-color: var(--vvf-rosso-scuro); }
        .bg-B { background-color: var(--vvf-arancio); }
        .bg-C { background-color: var(--vvf-rosso); }
        .bg-D { background-color: var(--vvf-giallo-oro); color: #333; /* Testo scuro per contrasto su giallo */ }

        /* Box Risultati con bordo Arancio e sfondo Giallo Chiaro */
        .result-box { background-color: var(--vvf-giallo-chiaro); border-left: 5px solid var(--vvf-arancio); padding: 15px; border-radius: 8px; margin-top: 20px; display: none; }
        
        .history-item { 
            border-bottom: 1px solid #eee; 
            padding: 15px 0; 
            display: flex; 
            flex-direction: column; 
            gap: 10px; 
        }
        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .history-date { font-weight: 800; color: var(--vvf-dark); font-size: 15px; }
        .history-sub { font-size: 13px; color: #666; }
        .history-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        .btn-delete { 
            background: none; border: none; color: var(--vvf-rosso); 
            padding: 0; margin: 5px 0 0 0; width: auto; 
            font-size: 12px; font-weight: 600; box-shadow: none; 
            text-decoration: underline; cursor: pointer;
        }
        
        /* Box Info Turno con bordo Rosso Vivo */
        .info-turno-box {
            background: white; 
            padding: 15px; 
            border-radius: 12px; 
            margin-top: 10px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.05); 
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            border-left: 4px solid var(--vvf-rosso);
        }

        /* TABELLA DETTAGLI */
        .detail-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        .detail-table td { padding: 8px; border-bottom: 1px solid #eee; font-size: 14px; }
        .detail-table tr:last-child td { border-bottom: none; font-weight: bold; }
        .detail-label { color: #666; }
        .detail-val { text-align: right; color: var(--vvf-dark); font-weight: 700; }
        .detail-notes { margin-top: 15px; font-size: 14px; color: #555; background: #f9f9f9; padding: 10px; border-radius: 8px; }
        .detail-notes strong { color: var(--vvf-dark); }

        .hidden { display: none !important; }
    </style>
</head>
<body>

    <!-- LOGO GLOBALE -->
    <div style="text-align: center; margin-top: 40px;">
        <div class="logo-container">
            <!-- APS VIGILI DEL FUOCO - DISEGNO TECNICO STILIZZATO -->
            <svg class="logo-svg" viewBox="0 0 120 70" xmlns="http://www.w3.org/2000/svg">
                <!-- Stile Linee -->
                <style>
                    .tech-line { fill: none; stroke: var(--vvf-rosso); stroke-width: 2.5; stroke-linecap: round; stroke-linejoin: round; }
                    .tech-detail { fill: none; stroke: var(--vvf-rosso); stroke-width: 1.5; }
                    .tech-accent { fill: none; stroke: var(--vvf-arancio); stroke-width: 2; }
                    .tech-light { fill: var(--vvf-giallo-oro); stroke: none; }
                </style>

                <!-- Cabina (Parte Anteriore) -->
                <path class="tech-line" d="M15 45 L15 25 L25 15 L40 15 L40 45 Z" />
                <path class="tech-detail" d="M25 15 L25 25 L40 25" /> <!-- Finestrino -->

                <!-- Carrozzeria (Parte Posteriore/Serrande) -->
                <path class="tech-line" d="M42 45 L42 15 L105 15 L105 45" />
                <!-- Linee Serrande -->
                <line class="tech-detail" x1="55" y1="20" x2="55" y2="40" />
                <line class="tech-detail" x1="70" y1="20" x2="70" y2="40" />
                <line class="tech-detail" x1="85" y1="20" x2="85" y2="40" />
                <rect class="tech-detail" x="45" y="18" width="55" height="24" rx="2" />

                <!-- Telaio/Passaruota -->
                <path class="tech-line" d="M10 45 L25 45 M55 45 L85 45 M115 45 L105 45" />

                <!-- Ruote -->
                <circle class="tech-line" cx="40" cy="45" r="8" />
                <circle class="tech-line" cx="95" cy="45" r="8" />
                <circle class="tech-detail" cx="40" cy="45" r="3" />
                <circle class="tech-detail" cx="95" cy="45" r="3" />

                <!-- Scala sul tetto (Dettaglio Arancio) -->
                <path class="tech-accent" d="M45 12 L100 8" />
                <line class="tech-accent" x1="50" y1="11" x2="50" y2="14" />
                <line class="tech-accent" x1="65" y1="10" x2="65" y2="13" />
                <line class="tech-accent" x1="80" y1="9" x2="80" y2="12" />
                <line class="tech-accent" x1="95" y1="8" x2="95" y2="11" />

                <!-- Lampeggiante (Giallo Oro) -->
                <path class="tech-light" d="M30 15 L30 10 L36 10 L36 15 Z" />
            </svg>
        </div>
    </div>

    <!-- SCHERMATA LOGIN -->
    <div id="view-login">
        <div class="header">
            <h1>INSERIMENTO ORE MISSIONE</h1>
            <p>VIGILI DEL FUOCO SIENA</p>
        </div>

        <div class="card">
            <p class="login-msg" id="login-intro">Identificativo Utente</p>
            
            <label>Nome Utente</label>
            <input type="text" id="username" placeholder="Es. MarioRossi" oninput="resetLoginUI()">
            
            <div id="password-section" class="hidden">
                <label>Password</label>
                <input type="password" id="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
            </div>

            <div id="register-section" class="hidden">
                <p style="color: var(--vvf-arancio); font-size: 13px; margin-top: 15px;">Nuovo utente rilevato. Imposta password.</p>
                <label>Crea Password</label>
                <input type="password" id="new-password" placeholder="Scegli password">
            </div>

            <p id="error-text" class="error-msg">Errore credenziali</p>

            <button id="btn-login-action" onclick="checkUser()">AVANTI</button>
        </div>
    </div>

    <!-- SCHERMATA APP -->
    <div id="view-app" class="hidden">
        <div class="header">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h1 style="font-size: 20px;">Registro Ore</h1>
                <span id="user-badge" style="background:#ddd; padding:4px 10px; border-radius:20px; font-size:11px; font-weight:bold; color: #555;">USER</span>
            </div>
            
            <div class="info-turno-box">
                <div>
                    <!-- Data odierna live -->
                    <strong id="data-live" style="font-size: 16px; color: var(--vvf-dark); text-transform: capitalize;">-- -- ----</strong>
                    <span style="font-size: 12px; color: #888; display:block; margin-top:2px;">In Servizio ore <span id="orario-live">--:--</span></span>
                </div>
                <div id="oggi-turno-badge">...</div>
            </div>
        </div>

        <div class="card">
            <label>AttivitÃ </label>
            <select id="tipo">
                <option value="Soccorso">ðŸ”¥ Straordinario SOCCORSO</option>
                <option value="Guida">ðŸš’ Ore di GUIDA</option>
                <option value="Boschivo">ðŸŒ² AIB / Boschivo</option>
            </select>

            <label>Inizio</label>
            <input type="datetime-local" id="inizio">

            <label>Fine</label>
            <input type="datetime-local" id="fine">

            <label>Note Operative</label>
            <textarea id="note" rows="2" placeholder="Riferimenti intervento..."></textarea>

            <button onclick="calcolaESalva()">REGISTRA E CALCOLA</button>

            <div id="risultato-box" class="result-box"></div>
            <button id="btn-vedi-dettaglio" class="secondary hidden" onclick="mostraDettaglioUltimo()">VEDI DETTAGLI FASCE ORARIE</button>
        </div>

        <div class="card">
            <h3 style="color: var(--vvf-dark); margin-top:0;">Storico</h3>
            <div id="lista-storico"></div>
            <button class="ghost" onclick="resetStorico()">Reset Storico</button>
        </div>

        <button class="ghost" onclick="logout()">Logout</button>
    </div>

    <!-- NUOVA SCHERMATA: DETTAGLIO CALCOLI -->
    <div id="view-detail" class="hidden">
        <div class="header">
            <h1 style="font-size: 22px;">Dettaglio Fasce</h1>
            <p>Ripartizione Ore</p>
        </div>
        
        <div class="card">
            <div id="detail-content"></div>
            <button class="secondary" onclick="chiudiDettaglio()">CHIUDI</button>
        </div>
    </div>

    <script>
        // ===============================================
        //  1. CONFIGURAZIONE TURNI
        // ===============================================
        
        // Sequenza: C (08-20), B (20-08), D (08-20), C (20-08), A (08-20), D (20-08), B (08-20), A (20-08)
        const sequenzaTurni = ['C', 'B', 'D', 'C', 'A', 'D', 'B', 'A']; 
        
        // PUNTO ZERO: 1 Dicembre 2025 ore 08:00 = TURNO C (Indice 0)
        const dataAncora = new Date(2025, 11, 1, 8, 0, 0); // 11 = Dicembre

        // LISTA GIORNI SUPER FESTIVI (Giorno/Mese)
        const superFestiviFissi = [
            "1/1", "6/1", "25/4", "1/5", "2/6", "15/8", "1/11", "8/12", "25/12", "26/12"
        ];

        // Calcolo Pasqua
        function isPasquaOPasquetta(date) {
            const pasque = ["2025-04-20", "2026-04-05"]; 
            const pasquette = ["2025-04-21", "2026-04-06"];
            let iso = date.toISOString().split('T')[0];
            return pasque.includes(iso) || pasquette.includes(iso);
        }

        function getTurno(dataOggetto) {
            let diffMs = dataOggetto.getTime() - dataAncora.getTime();
            let diffOre = diffMs / (1000 * 60 * 60);
            let blocchiDa12Ore = Math.floor(diffOre / 12);
            let indice = ((blocchiDa12Ore % 8) + 8) % 8;
            return sequenzaTurni[indice];
        }

        // ===============================================
        //  2. LOGICA LOGIN
        // ===============================================
        let dbUtenti = JSON.parse(localStorage.getItem('vvf_users_db') || '{}');
        let currentUser = null;
        let loginState = 'check';

        function checkUser() {
            let userField = document.getElementById('username');
            let user = userField.value.trim();
            
            if(!user) return;

            if (loginState === 'check') {
                if (dbUtenti.hasOwnProperty(user)) {
                    document.getElementById('password-section').classList.remove('hidden');
                    document.getElementById('btn-login-action').innerText = "ACCEDI";
                    loginState = 'login';
                    userField.disabled = true;
                } else {
                    document.getElementById('register-section').classList.remove('hidden');
                    document.getElementById('btn-login-action').innerText = "REGISTRA";
                    loginState = 'register';
                    userField.disabled = true;
                }
            } else if (loginState === 'login') {
                if (dbUtenti[user] === document.getElementById('password').value) avviaApp(user);
                else { document.getElementById('error-text').style.display = 'block'; }
            } else if (loginState === 'register') {
                let newPass = document.getElementById('new-password').value;
                if (newPass) {
                    dbUtenti[user] = newPass;
                    localStorage.setItem('vvf_users_db', JSON.stringify(dbUtenti));
                    avviaApp(user);
                }
            }
        }

        function resetLoginUI() {
            document.getElementById('password-section').classList.add('hidden');
            document.getElementById('register-section').classList.add('hidden');
            document.getElementById('btn-login-action').innerText = "AVANTI";
            document.getElementById('error-text').style.display = 'none';
            loginState = 'check';
        }

        function avviaApp(user) {
            currentUser = user;
            document.getElementById('view-login').classList.add('hidden');
            document.getElementById('view-app').classList.remove('hidden');
            document.getElementById('user-badge').innerText = user;
            impostaDateDefault();
            aggiornaLiveUI();
            setInterval(aggiornaLiveUI, 60000);
            caricaStorico();
        }

        function logout() { location.reload(); }

        // ===============================================
        //  3. CORE APP & NUOVO CALCOLO DETTAGLIATO
        // ===============================================

        let ultimoCalcoloDettagli = null; 

        function aggiornaLiveUI() {
            let now = new Date();
            let turno = getTurno(now);
            
            let opzioniData = { weekday: 'short', day: 'numeric', month: 'short', year: 'numeric' };
            document.getElementById('data-live').innerText = now.toLocaleDateString('it-IT', opzioniData);
            
            let ore = String(now.getHours()).padStart(2, '0');
            let min = String(now.getMinutes()).padStart(2, '0');
            document.getElementById('orario-live').innerText = `${ore}:${min}`;

            document.getElementById('oggi-turno-badge').innerHTML = 
                `<span class="badge bg-${turno}" style="font-size:1.4em; padding:8px 16px;">${turno}</span>`;
        }

        function impostaDateDefault() {
            let now = new Date();
            now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            document.getElementById('inizio').value = now.toISOString().slice(0,16);
            document.getElementById('fine').value = now.toISOString().slice(0,16);
        }

        // Funzione helper per categorizzare un timestamp specifico
        function getCategoriaOraria(dateObj) {
            let h = dateObj.getHours();
            let d = dateObj.getDate();
            let m = dateObj.getMonth() + 1; // 1-12
            let keyDate = `${d}/${m}`;
            let dayOfWeek = dateObj.getDay(); // 0 = Domenica, 6 = Sabato

            // 1. REGOLA D'ORO: Se non siamo tra le 06:00 e le 22:00, Ã¨ Notturno
            if (h < 6 || h >= 22) {
                return 'notturno';
            }

            // SE SIAMO QUI, SIAMO CERTAMENTE TRA LE 06:00 E LE 22:00
            
            // 2. Controllo Super Festivi
            if (superFestiviFissi.includes(keyDate) || isPasquaOPasquetta(dateObj)) {
                return 'super_festivo';
            }

            // 3. Controllo Festivi (SOLO DOMENICA)
            if (dayOfWeek === 0) {
                return 'festivo';
            }

            // 4. Tutto il resto Ã¨ Feriale Diurno
            return 'feriale';
        }

        function calcolaESalva() {
            let inizio = new Date(document.getElementById('inizio').value);
            let fine = new Date(document.getElementById('fine').value);
            let tipo = document.getElementById('tipo').value;
            let note = document.getElementById('note').value;

            if (fine <= inizio) { alert("Errore: Fine precedente all'inizio."); return; }

            // A. Calcolo Segmenti Turno
            let segmenti = [];
            let cursore = new Date(inizio);
            let totaleOre = 0;

            while (cursore < fine) {
                let prossimoCambio = new Date(cursore);
                let ora = cursore.getHours();
                if (ora >= 8 && ora < 20) prossimoCambio.setHours(20, 0, 0, 0);
                else {
                    if (ora >= 20) prossimoCambio.setDate(prossimoCambio.getDate() + 1);
                    prossimoCambio.setHours(8, 0, 0, 0);
                }
                let fineSegmento = (prossimoCambio < fine) ? prossimoCambio : fine;
                let durataOre = (fineSegmento - cursore) / (1000 * 60 * 60);
                let pm = new Date(cursore.getTime() + ((fineSegmento - cursore) / 2));
                
                segmenti.push({ turno: getTurno(pm), ore: durataOre });
                totaleOre += durataOre;
                cursore = fineSegmento;
            }

            // B. CALCOLO DETTAGLIATO FASCE (Minuto per minuto)
            let dettagli = { feriale: 0, festivo: 0, super_festivo: 0, notturno: 0 };
            
            let timeScanner = new Date(inizio);
            timeScanner.setSeconds(0,0); 

            let fineMs = fine.getTime();
            let currentMs = timeScanner.getTime();
            
            while(currentMs < fineMs) {
                let tempDate = new Date(currentMs);
                let cat = getCategoriaOraria(tempDate);
                dettagli[cat] += (1/60);
                currentMs += 60000;
            }

            let turnoRientro = getTurno(new Date(fine.getTime() - 1000));

            ultimoCalcoloDettagli = dettagli;

            let record = {
                id: Date.now(),
                tipo: tipo,
                inizio: inizio.toISOString(),
                fine: fine.toISOString(),
                totale: totaleOre.toFixed(2),
                rientro: turnoRientro,
                segmenti: segmenti,
                dettagli: dettagli,
                note: note
            };
            salvaRecord(record);

            mostraRisultatoBox(totaleOre, segmenti, turnoRientro);
        }

        function mostraRisultatoBox(totale, segmenti, turnoRientro) {
            let htmlRes = `<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                            <strong>TOTALE</strong> 
                            <span style="font-size:1.4em; font-weight:800; color:var(--vvf-rosso);">${totale.toFixed(2)} ore</span>
                           </div>`;
            
            segmenti.forEach(s => {
                htmlRes += `<div style="margin-bottom:4px; font-size:14px;">
                                â€¢ ${s.ore.toFixed(2)}h su <span class="badge bg-${s.turno}" style="font-size:0.8em; padding:2px 6px;">${s.turno}</span>
                            </div>`;
            });
            
            htmlRes += `<div style="margin-top:10px; border-top:1px solid #ccc; padding-top:10px; font-size:13px; color:#555;">
                        <b>SEGNA ORE AL TURNO:</b> <span class="badge bg-${turnoRientro}">${turnoRientro}</span></div>`;
            
            let box = document.getElementById('risultato-box');
            box.innerHTML = htmlRes;
            box.style.display = 'block';
            document.getElementById('btn-vedi-dettaglio').classList.remove('hidden');
        }

        // ===============================================
        //  4. GESTIONE VIEW DETTAGLI
        // ===============================================

        function mostraDettaglioUltimo() {
            // Passa anche le note correnti se presenti
            let noteCorrenti = document.getElementById('note').value;
            if(ultimoCalcoloDettagli) renderizzaDettagli(ultimoCalcoloDettagli, noteCorrenti);
        }

        function mostraDettaglioDaStorico(id) {
            let list = JSON.parse(localStorage.getItem(getHistoryKey()) || '[]');
            let item = list.find(x => x.id === id);
            if(item && item.dettagli) {
                // Passa anche le note salvate nello storico
                renderizzaDettagli(item.dettagli, item.note);
            } else {
                alert("Dettagli non disponibili per vecchie registrazioni.");
            }
        }

        // FUNZIONE PER CONVERTIRE ORE DECIMALI IN ORE E MINUTI
        function formattaOreMinuti(oreDecimali) {
            let ore = Math.floor(oreDecimali);
            let minuti = Math.round((oreDecimali - ore) * 60);
            return `${ore}h ${String(minuti).padStart(2, '0')}m`;
        }

        function renderizzaDettagli(d, note) {
            let html = `
                <table class="detail-table">
                    <tr>
                        <td class="detail-label">Feriali (06:00-22:00)</td>
                        <td class="detail-val" style="color:var(--vvf-dark)">${formattaOreMinuti(d.feriale)}</td>
                    </tr>
                    <tr>
                        <td class="detail-label">Festivi (06:00-22:00)</td>
                        <td class="detail-val" style="color:var(--vvf-arancio)">${formattaOreMinuti(d.festivo)}</td>
                    </tr>
                    <tr>
                        <td class="detail-label">Super Festivi (06:00-22:00)</td>
                        <td class="detail-val" style="color:var(--vvf-rosso)">${formattaOreMinuti(d.super_festivo)}</td>
                    </tr>
                    <tr>
                        <td class="detail-label">Notturne (22:00-06:00)</td>
                        <td class="detail-val" style="color:var(--vvf-rosso-scuro)">${formattaOreMinuti(d.notturno)}</td>
                    </tr>
                    <tr style="background:#eee;">
                        <td>TOTALE</td>
                        <td class="detail-val">${formattaOreMinuti(d.feriale+d.festivo+d.super_festivo+d.notturno)}</td>
                    </tr>
                </table>
                <p style="font-size:12px; color:#888; margin-top:10px;">
                    * NOTA: Le fasce Feriali/Festive si applicano SOLO dalle 06:00 alle 22:00. <br>
                    Tutto il resto Ã¨ considerato fascia Notturna.
                </p>
            `;

            // Aggiunge le note se presenti
            if (note && note.trim() !== "") {
                html += `
                    <div class="detail-notes">
                        <strong>Note Operative:</strong><br>
                        ${note}
                    </div>
                `;
            }
            
            document.getElementById('detail-content').innerHTML = html;
            document.getElementById('view-app').classList.add('hidden');
            document.getElementById('view-detail').classList.remove('hidden');
        }

        function chiudiDettaglio() {
            document.getElementById('view-detail').classList.add('hidden');
            document.getElementById('view-app').classList.remove('hidden');
        }

        // ===============================================
        //  5. PERSISTENZA STORICO
        // ===============================================

        function getHistoryKey() { return `vvf_history_${currentUser}`; }

        function salvaRecord(record) {
            let key = getHistoryKey();
            let list = JSON.parse(localStorage.getItem(key) || '[]');
            list.unshift(record);
            localStorage.setItem(key, JSON.stringify(list));
            caricaStorico();
        }

        function caricaStorico() {
            let list = JSON.parse(localStorage.getItem(getHistoryKey()) || '[]');
            let container = document.getElementById('lista-storico');
            
            if (list.length === 0) { container.innerHTML = '<p style="text-align:center; font-size:13px; color:#999;">Nessuna registrazione.</p>'; return; }

            let html = '';
            list.forEach(item => {
                let dIniz = new Date(item.inizio);
                let dFin = new Date(item.fine);
                let dataStr = dIniz.toLocaleDateString('it-IT', {day:'numeric', month:'short'});
                
                html += `
                <div class="history-item">
                    <div class="history-header">
                        <span class="history-date">${dataStr}</span>
                        <span class="badge bg-${item.rientro}" style="transform:scale(0.9)">${item.rientro}</span>
                    </div>
                    <div class="history-sub">
                        <strong>${item.tipo}</strong>: ${item.totale}h <br>
                    </div>
                    <div class="history-actions">
                        <button class="ghost" style="padding:5px 10px; width:auto; font-size:12px; margin:0;" onclick="mostraDettaglioDaStorico(${item.id})">Dettagli</button>
                        <button class="btn-delete" style="margin:0; font-size:12px;" onclick="eliminaRecord(${item.id})">Elimina</button>
                    </div>
                </div>`;
            });
            container.innerHTML = html;
        }

        function eliminaRecord(id) {
            if(!confirm("Eliminare?")) return;
            let key = getHistoryKey();
            let list = JSON.parse(localStorage.getItem(key) || '[]');
            localStorage.setItem(key, JSON.stringify(list.filter(x => x.id !== id)));
            caricaStorico();
        }

        function resetStorico() {
            if(confirm("Cancellare tutto?")) { localStorage.removeItem(getHistoryKey()); caricaStorico(); }
        }
    </script>
</body>
</html>
